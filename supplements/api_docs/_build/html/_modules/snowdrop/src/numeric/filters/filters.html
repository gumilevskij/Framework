<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>snowdrop.src.numeric.filters.filters &#8212; Python Platform 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for snowdrop.src.numeric.filters.filters</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Feb 26 18:49:21 2018</span>

<span class="sd">@author: agoumilevski</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">la</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">spdiags</span><span class="p">,</span><span class="n">lil_matrix</span><span class="p">,</span><span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">fftconvolve</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">sla</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">butter</span><span class="p">,</span><span class="n">lfilter</span>
<span class="kn">from</span> <span class="nn">snowdrop.src.misc.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>

<span class="n">oldK</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="LRXfilter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.LRXfilter">[docs]</a>
<span class="k">def</span> <span class="nf">LRXfilter</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">lmbd</span><span class="o">=</span><span class="mi">1600</span><span class="p">,</span> <span class="n">w1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">w2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">w3</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply enchanced HP filter.</span>
<span class="sd">    </span>
<span class="sd">    This is LRX filter named after Laxton-Rose-Xie.</span>
<span class="sd">   </span>
<span class="sd">    A brief explanation of terms used in LRX filter</span>
<span class="sd">    </span>
<span class="sd">    Syntax: </span>
<span class="sd">        y_eq = LRXfilter(y,lmbd[,w1[,w2[,w3[,DPRIOR[,PRIOR]]]]])</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        lmbd: float</span>
<span class="sd">            tightness constraint for HP filter,</span>
<span class="sd">        y:  array, dtype=float</span>
<span class="sd">            series to be detrended,</span>
<span class="sd">        w1: float</span>
<span class="sd">            weight on (y - y_eq)^2,</span>
<span class="sd">        w2: float</span>
<span class="sd">            weight on [(y_eq - y_eq(-1)) - dprior]^2,</span>
<span class="sd">        w3: float</span>
<span class="sd">            weight on (y_eq - prior)^2,</span>
<span class="sd">        dprior: array, dtype=float</span>
<span class="sd">            growth rate of y in steady-state,</span>
<span class="sd">        prior: array, dtype=float</span>
<span class="sd">            previously computed y_eq.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        y_eq: The trend component,</span>
<span class="sd">        </span>
<span class="sd">        gap: The cycle component</span>
<span class="sd">      </span>
<span class="sd">    .. note::</span>
<span class="sd">        the default value of lmbd is 1600,</span>
<span class="sd">        </span>
<span class="sd">        the default value of w1 is a vector of ones,</span>
<span class="sd">        </span>
<span class="sd">        the default value of w2 is a vector of zeros,</span>
<span class="sd">        </span>
<span class="sd">        the default value of w3 is a vector of zeros,</span>
<span class="sd">        </span>
<span class="sd">        the default value of dpr is a vector of zeros,</span>
<span class="sd">        </span>
<span class="sd">        the default value of pr is a vector of zeros,</span>
<span class="sd">        </span>
<span class="sd">        if any of w1, w2, w3, dpr, pr is of length 1, then it is extended to</span>
<span class="sd">        a vector of the appropriate length, in which all the entries are</span>
<span class="sd">        equal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">index</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dprior</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">dprior</span> <span class="o">=</span> <span class="n">dprior</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">values</span>
        
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">w1</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">w2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w2</span> <span class="o">*=</span> <span class="n">w2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">w3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">w3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w3</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">dprior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
       <span class="n">dprior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">dprior</span><span class="p">):</span>
       <span class="n">dprior</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span>  <span class="n">prior</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">prior</span><span class="p">):</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
    
    <span class="c1"># This is the main part of the function</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># use sparse matrix to save memory and unnecessary computation</span>
    <span class="n">MW1</span> <span class="o">=</span> <span class="n">spdiags</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">MW2</span> <span class="o">=</span> <span class="n">spdiags</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">MW3</span> <span class="o">=</span> <span class="n">spdiags</span><span class="p">(</span><span class="n">w3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> 
    <span class="n">Y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">@</span> <span class="n">MW1</span> <span class="o">+</span>  <span class="n">prior</span> <span class="o">@</span> <span class="n">MW3</span> <span class="o">+</span> <span class="n">dprior</span> <span class="o">@</span> <span class="n">MW2</span> <span class="o">@</span> <span class="n">B</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">XX</span> <span class="o">=</span> <span class="n">lmbd</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">MW2</span> <span class="o">@</span> <span class="n">B</span> <span class="o">+</span> <span class="n">MW1</span> <span class="o">+</span> <span class="n">MW3</span>
    <span class="n">y_eq</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">gap</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_eq</span>
    
    <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_eq</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">gap</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_eq</span><span class="o">.</span><span class="n">T</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">gap</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">gap</span></div>

        

<div class="viewcode-block" id="HPF">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.HPF">[docs]</a>
<span class="k">def</span> <span class="nf">HPF</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lmbd</span><span class="o">=</span><span class="mi">1600</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hodrick-Prescott filter to a time series.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">vals</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">LRXfilter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">lmbd</span><span class="o">=</span><span class="n">lmbd</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">gap</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">filtered</span>
    <span class="k">return</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">gap</span></div>

      

<div class="viewcode-block" id="HPfilter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.HPfilter">[docs]</a>
<span class="k">def</span> <span class="nf">HPfilter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lmbd</span><span class="o">=</span><span class="mi">1600</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a Hodrick-Prescott filter to a dataset.</span>
<span class="sd">    </span>
<span class="sd">    The return value is the filtered data-set found according to:</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        \min_{T_{t}}[ \sum_{t=0}((X_{t} - T_{t})^2 + \lambda*((T_{t+1} - T_{t}) - (T_{t} - T_{t-1}))^2) ]</span>


<span class="sd">    Args:</span>
<span class="sd">        data: array, dtype=float</span>
<span class="sd">            The data set for which you want to apply the HP filter.</span>
<span class="sd">            This mustbe a numpy array.</span>
<span class="sd">        lmbd: array, dtype=float</span>
<span class="sd">            This is the value for lambda as used in the equation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        T: array, dtype=float</span>
<span class="sd">            The solution to the minimization equation above (the trend).</span>
<span class="sd">        Cycle: array, dtype=float</span>
<span class="sd">            This is the &#39;stationary data&#39; found by X - T.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This function implements sparse methods to be efficient enough to handle</span>
<span class="sd">        very large data sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="p">[</span><span class="n">HPfilter</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">(</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">Cycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">(</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">T</span><span class="p">,</span><span class="n">Cycle</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HP filter is not defined for dimension &gt;= 3.&#39;</span><span class="p">)</span>

    <span class="n">lil_t</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">big_Lambda</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">lil_t</span><span class="p">,</span> <span class="n">lil_t</span><span class="p">)</span>
    <span class="n">big_Lambda</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">(</span><span class="n">big_Lambda</span><span class="p">)</span>

    <span class="c1"># Use FOC&#39;s to build rows by group. The first and last rows are similar.</span>
    <span class="c1"># As are the second-second to last. Then all the ones in the middle...</span>
    <span class="n">first_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">+</span> <span class="n">lmbd</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lmbd</span><span class="p">,</span> <span class="n">lmbd</span><span class="p">])</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lmbd</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">lmbd</span><span class="p">),</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">lmbd</span><span class="p">,</span> <span class="n">lmbd</span><span class="p">])</span>
    <span class="n">middle_stuff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lmbd</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">lmbd</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">lmbd</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">lmbd</span><span class="p">,</span> <span class="n">lmbd</span><span class="p">])</span>

    <span class="c1">#--------------------------- Putting it together --------------------------#</span>

    <span class="c1"># First two rows</span>
    <span class="n">big_Lambda</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_last</span>
    <span class="n">big_Lambda</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">second</span>

    <span class="c1"># Last two rows. Second to last first : we have to reverse arrays</span>
    <span class="n">big_Lambda</span><span class="p">[</span><span class="n">lil_t</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">second</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">big_Lambda</span><span class="p">[</span><span class="n">lil_t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">first_last</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Middle rows</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">lil_t</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">big_Lambda</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">middle_stuff</span>

    <span class="c1"># spla.spsolve requires csr or csc matrix. I choose csr for fun.</span>
    <span class="n">big_Lambda</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">big_Lambda</span><span class="p">)</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">sla</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="n">big_Lambda</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

    <span class="n">Cycle</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">T</span>

    <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">Cycle</span></div>

	

<div class="viewcode-block" id="bandpass_filter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.bandpass_filter">[docs]</a>
<span class="k">def</span> <span class="nf">bandpass_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a bandpass filter to data.</span>
<span class="sd">    </span>
<span class="sd">    This band-pass filter is of kth order.  It selects the band between w1 and w2.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: array, dtype=float</span>
<span class="sd">            The data you wish to filter</span>
<span class="sd">        k: number, int</span>
<span class="sd">            The order of approximation for the filter. A max value for</span>
<span class="sd">            this is data.size/2</span>
<span class="sd">        w1: number, float</span>
<span class="sd">            This is the lower bound for which frequencies will pass</span>
<span class="sd">            through.</span>
<span class="sd">        w2: number, float</span>
<span class="sd">            This is the upper bound for which frequencies will pass</span>
<span class="sd">            through.</span>

<span class="sd">    Returns:</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">            The filtered data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">low_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">w2</span>
    <span class="n">high_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">w1</span>
    <span class="n">bweights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bweights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">high_w</span> <span class="o">-</span> <span class="n">low_w</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">high_w</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">low_w</span> <span class="o">*</span> <span class="n">j</span><span class="p">))</span>
    <span class="n">bweights</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
    <span class="n">bweights</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">bweights</span> <span class="o">-=</span> <span class="n">bweights</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">bweights</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="c1">#&#39;full&#39;</span>
    
    <span class="k">return</span> <span class="n">filtered</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

 
    
<div class="viewcode-block" id="BPASS">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.BPASS">[docs]</a>
<span class="k">def</span> <span class="nf">BPASS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">W1</span><span class="p">,</span><span class="n">W2</span><span class="p">,</span><span class="n">drift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">bChristianoFitzgerald</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bandpass filter to time series.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="kn">import</span> <span class="n">rfft</span><span class="p">,</span> <span class="n">irfft</span><span class="p">,</span> <span class="n">fftfreq</span>
    <span class="kn">from</span> <span class="nn">statsmodels.tsa.filters.cf_filter</span> <span class="kn">import</span> <span class="n">cffilter</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">time</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>
    
    <span class="k">if</span> <span class="n">bChristianoFitzgerald</span><span class="p">:</span>
        <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">cffilter</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">low</span><span class="o">=</span><span class="n">W1</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="n">W2</span><span class="p">,</span><span class="n">drift</span><span class="o">=</span><span class="n">drift</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cutoff</span><span class="p">:</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
            <span class="n">f_signal</span> <span class="o">=</span> <span class="n">rfft</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>    
            <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f_signal</span><span class="p">)</span>
            <span class="n">filtered_signal</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1.</span><span class="o">/</span><span class="n">W1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">filtered_signal</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.</span><span class="o">/</span><span class="n">W2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">irfft</span><span class="p">(</span><span class="n">filtered_signal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">delta</span>
            <span class="n">nyq</span> <span class="o">=</span> <span class="mf">365.0</span><span class="o">/</span><span class="mf">2.0</span>
            <span class="n">low</span> <span class="o">=</span> <span class="mf">365.0</span><span class="o">/</span><span class="n">W2</span><span class="o">/</span><span class="n">nyq</span>
            <span class="n">high</span> <span class="o">=</span> <span class="mf">365.0</span><span class="o">/</span><span class="n">W1</span><span class="o">/</span><span class="n">nyq</span>
            <span class="n">b</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">butter</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">Wn</span><span class="o">=</span><span class="p">[</span><span class="n">low</span><span class="p">,</span><span class="n">high</span><span class="p">]</span><span class="o">*</span><span class="n">fs</span><span class="p">,</span><span class="n">btype</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">)</span>
            <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">filtered_signal</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span></div>

	

<div class="viewcode-block" id="Standard_Kalman_Filter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Standard_Kalman_Filter">[docs]</a>
<span class="k">def</span> <span class="nf">Standard_Kalman_Filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement Kalman filter algorithm for state-space model.</span>

<span class="sd">    This implementation assumes that measurement equation is specified at time t. </span>

<span class="sd">    .. math:: </span>
<span class="sd">            x_{t+1} = T_{t} * x_{t} + C_{t}  + w_{t},  w_{t} = Normal(0, Q),</span>
<span class="sd">            </span>
<span class="sd">            y_{t+1} = Z_{t} * x_{t+1} + v_{t},  v_{t} = Normal(0, H)</span>
<span class="sd">		</span>
<span class="sd">      </span>
<span class="sd">    KF uses two phase algorithm</span>

<span class="sd">    Predict</span>
<span class="sd">    </span>
<span class="sd">    .. math:: </span>
<span class="sd">            x_{t|t} &amp;= x_{t|t-1} + P_{t|t-1} * L_{t} * (y_{t} - Z_{t} * x_{t|t-1})</span>
<span class="sd">            </span>
<span class="sd">            P_{t|t} &amp;= P_{t|t-1} - L * Z_{t} * P_{t|t-1}</span>
<span class="sd">            </span>
<span class="sd">            L{t} &amp;= Z_{t} * [Z_{t}*P_{t|t-1}*Z&#39;_{t} + H]^{-1}</span>
<span class="sd">		</span>
<span class="sd">    Update</span>
<span class="sd">    </span>
<span class="sd">    .. math:: </span>
<span class="sd">    	   v_{t} &amp;= y_{t} - Z_{t} * x_{t|t-1}</span>
<span class="sd">           </span>
<span class="sd">    	   x_{t+1|t} &amp;= T_{t} * x_{t|t} + C_{t}</span>
<span class="sd">           </span>
<span class="sd">    	   P_{t+1|t} &amp;= T_{t} * P_{t|t} * T&#39;_{t} + Q_{t}</span>


<span class="sd">    Args:</span>
<span class="sd">        x : array, dtype=float</span>
<span class="sd">            is the state variables,</span>
<span class="sd">        y : array, dtype=float</span>
<span class="sd">            is the observation variables,</span>
<span class="sd">        T : 2D array, dtype=float</span>
<span class="sd">            is the state-transition matrix,</span>
<span class="sd">        Z : 2D array, dtype=float</span>
<span class="sd">            is the observation matrix,</span>
<span class="sd">        P : 2D array, dtype=float</span>
<span class="sd">            is the predicted error covariance matrix,</span>
<span class="sd">        Q : 2D array, dtype=float</span>
<span class="sd">            is the covariance matrix of state variables (endogenous variables),</span>
<span class="sd">        H : 2D array, dtype=float</span>
<span class="sd">            is the covariance matrix of space variables (measurement variables),</span>
<span class="sd">        C : array, dtype=float</span>
<span class="sd">            is the constant term matrix,</span>
<span class="sd">        ind_non_missing : array, dtype=int</span>
<span class="sd">            are the indices of non-missing observations.</span>
<span class="sd">  </span>
<span class="sd">    For details, please see https://stanford.edu/class/ee363/lectures/kf.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>

    <span class="n">iF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_meas</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">K</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">ZZ</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>
        
    
    <span class="c1"># Measurement pre-fit residual</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="n">x</span>  <span class="o">+</span> <span class="n">C</span><span class="p">)</span>
       
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">x</span>
        
    <span class="k">else</span><span class="p">:</span>
            
        <span class="k">if</span> <span class="kc">True</span> <span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span>    <span class="c1"># pre-fit residual covariance</span>
            <span class="n">iF</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>        <span class="c1"># matrix inverse </span>
            <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span>  <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span>  <span class="c1"># Kalman gain</span>
            
            <span class="c1"># Prediction step</span>
            <span class="n">x</span> <span class="o">+=</span>  <span class="n">K</span> <span class="o">@</span> <span class="n">v</span>            <span class="c1"># predicted state estimate eq (4.26) DK(2012)</span>
            <span class="n">P</span> <span class="o">-=</span> <span class="n">K</span> <span class="o">@</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">P</span>        <span class="c1"># predicted error covariance</span>
            
            
        <span class="k">else</span><span class="p">:</span>   
            <span class="n">F</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span>    <span class="c1"># pre-fit residual covariance</span>
            <span class="n">iF</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>        <span class="c1"># matrix inverse </span>
            <span class="n">M</span>  <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span>
            <span class="n">PZ</span> <span class="o">=</span> <span class="n">M</span> <span class="o">@</span> <span class="n">iF</span>
            
            <span class="c1"># Prediction step</span>
            <span class="n">x</span> <span class="o">+=</span>  <span class="n">PZ</span> <span class="o">@</span> <span class="n">v</span>           <span class="c1"># predicted state estimate eq (4.26) DK(2012)</span>
            <span class="n">P</span> <span class="o">-=</span> <span class="n">M</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">M</span><span class="o">.</span><span class="n">T</span>      <span class="c1"># predicted error covariance</span>
            <span class="n">K</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">M</span>             <span class="c1"># Kalman gain</span>
        
        <span class="c1"># Update step </span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">x</span>  <span class="o">+</span> <span class="n">C</span>        <span class="c1"># updated state estimate</span>
        <span class="n">P</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>   <span class="c1"># updated error covariance</span>
        <span class="n">P</span>  <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>       <span class="c1"># Force covariance matrix to be symmetric</span>
            
        <span class="c1"># Log-likelihood of the observed data</span>
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_meas</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">xn</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">iF</span><span class="p">,</span> <span class="n">log_likelihood</span></div>



<div class="viewcode-block" id="Kalman_Filter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Kalman_Filter">[docs]</a>
<span class="k">def</span> <span class="nf">Kalman_Filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bUnivariate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement Kalman filter algorithm for state-space model.</span>
<span class="sd"> </span>
<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the state variables,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the predicted error covariance matrix,</span>
<span class="sd">        Q: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of state variables (endogenous variables),</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of space variables (measurement variables),</span>
<span class="sd">        C: array, dtype=float</span>
<span class="sd">           is the constant term matrix,</span>
<span class="sd">        bUnivariate: bool</span>
<span class="sd">           if True univariate Kalman filter is used and if False - multivariate,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">           are the indices of non-missing observations,</span>
<span class="sd">        tol: number, dtype=float</span>
<span class="sd">           is the tolerance parameter (iteration over the Riccati equation)</span>
<span class="sd">      </span>
<span class="sd">    For details, see https://en.wikipedia.org/wiki/Kalman_filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">oldK</span>
    
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_states</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>
        
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="n">F</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">iF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_meas</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">K</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">ZZ</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>
    
    <span class="c1"># Prediction step</span>
    <span class="n">P</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>                        <span class="c1"># predicted error covariance</span>
    
    <span class="c1"># Measurement pre-fit residual</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">x</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Update step</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">+</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span>                    <span class="c1"># pre-fit residual covariance</span>
        <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>                          <span class="c1"># matrix inverse</span>
        <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span>     <span class="c1"># optimal Kalman gain</span>
        
        <span class="c1"># Update (a posteriori) state estimate</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">v</span><span class="p">)</span>                                
        <span class="c1"># Update (a posteriori) estimate covariance  </span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">K</span><span class="nd">@Z</span><span class="p">)</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">K</span><span class="nd">@Z</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">H</span> <span class="o">@</span> <span class="n">K</span><span class="o">.</span><span class="n">T</span>   <span class="c1"># This is a general case.</span>
        <span class="c1"># Force the covariance matrix to be symmetric</span>
        <span class="n">P</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="o">+</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        
        <span class="n">steady</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">K</span><span class="o">-</span><span class="n">oldK</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">tol</span>
        <span class="n">oldK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    
        <span class="c1"># Log-likelihood of the observed data</span>
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_meas</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span><span class="p">)</span>
                        
    <span class="k">return</span> <span class="n">xn</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">iF</span><span class="p">,</span> <span class="n">log_likelihood</span><span class="p">,</span> <span class="n">steady</span></div>



<div class="viewcode-block" id="Kalman_Filter_SS">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Kalman_Filter_SS">[docs]</a>
<span class="k">def</span> <span class="nf">Kalman_Filter_SS</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">iF</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement Kalman filter algorithm for stationary state-space model.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the state variables,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        K: 2D array, dtype=float</span>
<span class="sd">           is the Kalman gain matrix,</span>
<span class="sd">        F: 2D array, dtype=float</span>
<span class="sd">           is the pre-fit residual covariance,</span>
<span class="sd">        iF: 2D array, dtype=float</span>
<span class="sd">           is the inverse of the pre-fit residual covariance,</span>
<span class="sd">        C: array, dtype=float</span>
<span class="sd">           is the constant term matrix,</span>
<span class="sd">        bUnivariate: bool</span>
<span class="sd">           if True univariate Kalman filter is used and if False - multivariate,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">           are the indices of non-missing observations,</span>
<span class="sd">        tol: number, dtype=float</span>
<span class="sd">           is the tolerance parameter</span>
<span class="sd">      </span>
<span class="sd">    For details, see https://en.wikipedia.org/wiki/Kalman_filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>
        
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="c1"># Measurement pre-fit residual</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">x</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Update (a posteriori) state estimate</span>
        <span class="n">xn</span> <span class="o">=</span>  <span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="n">v</span><span class="p">)</span>    
        <span class="c1"># Log-likelihood of the observed data</span>
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_meas</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span><span class="p">)</span>
                        
    <span class="k">return</span> <span class="n">xn</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">log_likelihood</span></div>

    

<div class="viewcode-block" id="fast_kalman_filter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.fast_kalman_filter">[docs]</a>
<span class="k">def</span> <span class="nf">fast_kalman_filter</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">kalman_tol</span><span class="o">=</span><span class="mf">1.e-10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the likelihood of a stationary state space model, given initial condition for the states (mean and variance).</span>
<span class="sd">    </span>
<span class="sd">    References: </span>
<span class="sd">        Edward P. Herbst, (2012). &#39;Using the ”Chandrasekhar Recursions” </span>
<span class="sd">        for Likelihood Evaluation of DSGE Models&#39;&#39;</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        Y:  array, dtype=float</span>
<span class="sd">            Measurement data,</span>
<span class="sd">        N:  scalar, int</span>
<span class="sd">            Last period,</span>
<span class="sd">        a:  array, dtype=float</span>
<span class="sd">            Initial mean of the state vector,</span>
<span class="sd">        P:  2D array, dtype=float </span>
<span class="sd">            Initial covariance matrix of the state vector,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">            Transition matrix of the state equation,</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">            Covariance matrix of the measurement errors (if no measurement errors set H as a zero scalar),</span>
<span class="sd">        Z: 2D array, dtype=float </span>
<span class="sd">            Matrix relating the states to the observed variables or vector of indices,</span>
<span class="sd">        kalman_tol: scalar, float</span>
<span class="sd">            Tolerance parameter (rcond, inversibility of the covariance matrix of the prediction errors),</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Number of measurements</span>
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Initialize some variables.</span>
    <span class="n">likk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>      <span class="c1"># Initialization of the vector gathering the densities.</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">F_singular</span>  <span class="o">=</span> <span class="kc">True</span>


    <span class="n">K</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span>
    <span class="n">F</span>  <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">H</span>
    <span class="n">W</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">iF</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="n">Kg</span> <span class="o">=</span> <span class="n">K</span> <span class="o">@</span> <span class="n">iF</span>
    <span class="n">M</span>  <span class="o">=</span> <span class="o">-</span><span class="n">iF</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">v</span>  <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">a</span>
        <span class="n">residuals</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">dF</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">kalman_tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dF</span><span class="p">)</span><span class="o">&lt;</span><span class="n">kalman_tol</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The univariate diffuse kalman filter should be used.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Pathological case, discard draw.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F_singular</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">likk</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dF</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span>
            <span class="n">a</span>       <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">a</span> <span class="o">+</span> <span class="n">Kg</span> <span class="o">@</span> <span class="n">v</span>
            <span class="n">ZWM</span>     <span class="o">=</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">W</span> <span class="o">@</span> <span class="n">M</span>
            <span class="n">ZWMWp</span>   <span class="o">=</span> <span class="n">ZWM</span> <span class="o">@</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span>
            <span class="n">M</span>       <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">ZWM</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">ZWM</span>
            <span class="n">F</span>       <span class="o">=</span> <span class="n">F</span> <span class="o">+</span> <span class="n">ZWMWp</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span>
            <span class="n">iF</span>      <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
            <span class="n">K</span>       <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">T</span> <span class="o">@</span> <span class="n">ZWMWp</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Kg</span>      <span class="o">=</span> <span class="n">K</span> <span class="o">@</span> <span class="n">iF</span>
            <span class="n">W</span>       <span class="o">=</span> <span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="n">Kg</span> <span class="o">@</span> <span class="n">Z</span><span class="p">)</span> <span class="o">@</span> <span class="n">W</span>

  
    <span class="k">if</span> <span class="n">F_singular</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The variance of the forecast error remains singular until the end of the sample&#39;</span><span class="p">)</span>

    <span class="c1"># Add observation&#39;s densities constants and divide by two.</span>
    <span class="n">likk</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">likk</span> <span class="o">+</span> <span class="n">n_meas</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

    <span class="c1"># Compute the log-likelihood.</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">likk</span><span class="p">)):</span>
        <span class="n">LIK</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.e20</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LIK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likk</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LIK</span><span class="p">,</span><span class="n">likk</span><span class="p">,</span><span class="n">residuals</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">P</span></div>



<div class="viewcode-block" id="Rauch_Tung_Striebel_Smoother">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Rauch_Tung_Striebel_Smoother">[docs]</a>
<span class="k">def</span> <span class="nf">Rauch_Tung_Striebel_Smoother</span><span class="p">(</span><span class="n">Ytp</span><span class="p">,</span><span class="n">Xt</span><span class="p">,</span><span class="n">Xtp</span><span class="p">,</span><span class="n">Ft</span><span class="p">,</span><span class="n">Pt</span><span class="p">,</span><span class="n">Ptp</span><span class="p">,</span><span class="n">Ttp</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement Rauch-Tung-Striebel (RTS) smoother for state-space model.  </span>
<span class="sd">    </span>
<span class="sd">    RTS algorithm is</span>
<span class="sd">                </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        L_{t} &amp;= P_{t|t} * F&#39;_{t} * P_{t+1|t}^{-1}</span>
<span class="sd">        </span>
<span class="sd">        X_{t|T} &amp;= X_{t|t} + L_{t} * (X_{t+1|T} - X_{t+1|t})</span>
<span class="sd">        </span>
<span class="sd">        P_{t|T} &amp;= P_{t+1|t} + L_{t} * (P_{t+1|T} - P_{t+1|t}) * L&#39;_{t}</span>

<span class="sd">	</span>
<span class="sd">    Args:</span>
<span class="sd">        Ytp: array, dtype=float</span>
<span class="sd">             is the smoothed state variables at time t+1,</span>
<span class="sd">        Xt: array, dtype=float</span>
<span class="sd">            is the state variables at time t,</span>
<span class="sd">        Xtp: array, dtype=float</span>
<span class="sd">             is the state variables at time t+1,</span>
<span class="sd">        Ft: 2D array, dtype=float</span>
<span class="sd">            is the state-transition matrix at time t,</span>
<span class="sd">        Pt: 2D array, dtype=float</span>
<span class="sd">            is the predicted error covariance matrix at time t,</span>
<span class="sd">        Ptp: 2D array, dtype=float</span>
<span class="sd">             is the predicted error covariance matrix at time t+1,</span>
<span class="sd">        Ttp: 2D array, dtype=float</span>
<span class="sd">             is the smoothed covariance matrix of state variables.</span>
<span class="sd">      </span>
<span class="sd">    For details, see https://en.wikipedia.org/wiki/Kalman_filter</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">L</span> <span class="o">=</span> <span class="n">Pt</span> <span class="o">@</span> <span class="n">Ft</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Ptp</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span>  <span class="n">Xt</span> <span class="o">+</span> <span class="n">L</span> <span class="o">@</span> <span class="p">(</span><span class="n">Ytp</span> <span class="o">-</span> <span class="n">Xtp</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Ptp</span> <span class="o">+</span> <span class="n">L</span> <span class="o">@</span> <span class="p">(</span><span class="n">Ttp</span> <span class="o">-</span> <span class="n">Ptp</span><span class="p">)</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span>
    
    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">P</span></div>



<div class="viewcode-block" id="Bryson_Frazier_Smoother">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Bryson_Frazier_Smoother">[docs]</a>
<span class="k">def</span> <span class="nf">Bryson_Frazier_Smoother</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">Sinv</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">l</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement modified Bryson-Frazier (BF) smoother for a state-space model.</span>
<span class="sd">    </span>
<span class="sd">    BF algorithm is:</span>
<span class="sd">                </span>
<span class="sd">    .. math::</span>
<span class="sd">        L_{t} &amp;= H&#39;_{t}*S_{t}^{-1}*H_{t} + (I-K_{t}*H_{t})&#39;*L_{t}*(I-K_{t}*H_{t})</span>
<span class="sd">        </span>
<span class="sd">        L_{t-1} &amp;= F&#39;_{t}*Lt_{t}*F_{t}</span>
<span class="sd">        </span>
<span class="sd">        L_{T} &amp;= 0</span>
<span class="sd">        </span>
<span class="sd">        l_{t} &amp;= -H&#39;_{t}*S_{t}^{-1}*u_{t} + (I-K_{t}*H_{t})&#39;*l_{t}</span>
<span class="sd">        </span>
<span class="sd">        l_{t-1} &amp;= F&#39;_{t}*lt_{t}</span>
<span class="sd">        </span>
<span class="sd">        l_{T} &amp;= 0                                                                   </span>
<span class="sd">        </span>
<span class="sd">    Smoothed variables and covariances</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">        xs_{t|T} &amp;= x_{t} - P_{t}*l_{t}</span>
<span class="sd">        </span>
<span class="sd">        P_{t|T} &amp;= P_{t} - P_{t}*L_{t}*P_{t}</span>
<span class="sd">        </span>

<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the state variables,</span>
<span class="sd">        u: array, dtype=float</span>
<span class="sd">           is the vector of one-step-ahead prediction errors</span>
<span class="sd">        F: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        K: 2D array, dtype=float</span>
<span class="sd">           is the Kalman gain,</span>
<span class="sd">        Sinv: 2D array, dtype=float</span>
<span class="sd">           is the inverse of matrix S,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the predicted error covariance matrix,</span>
<span class="sd">        L: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix,</span>
<span class="sd">        l: 2D array, dtype=float</span>
<span class="sd">           is the temporary matrix</span>
<span class="sd">  </span>
<span class="sd">    For details, see https://en.wikipedia.org/wiki/Kalman_filter</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="n">n</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">C</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">H</span> 
    <span class="n">Lt</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span> <span class="o">@</span> <span class="n">H</span> <span class="o">+</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L</span> <span class="o">@</span> <span class="n">C</span>               
    <span class="n">L</span>  <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Lt</span> <span class="o">@</span> <span class="n">F</span> 
    <span class="n">lt</span> <span class="o">=</span> <span class="o">-</span><span class="n">H</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Sinv</span> <span class="o">@</span> <span class="n">u</span> <span class="o">+</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">l</span>               
    <span class="n">l</span>  <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">lt</span> 
    <span class="c1"># Smoothed solution</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">P</span> <span class="o">@</span> <span class="n">l</span>
    <span class="c1"># and covariance</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">L</span> <span class="o">@</span> <span class="n">P</span>
    
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span><span class="n">Ps</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">l</span> </div>



<div class="viewcode-block" id="DK_Filter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.DK_Filter">[docs]</a>
<span class="k">def</span> <span class="nf">DK_Filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xtilde</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement non-diffusive Durbin &amp; Koopman version of Kalman filter algorithm for state-space model.</span>
<span class="sd">    </span>
<span class="sd">    Multivariate approach to Kalman filter.</span>
<span class="sd">    </span>
<span class="sd">    State-space model</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        x_{t} = T_{t} * x_{t-1} + C_{t}  + w_{t},  w = Normal(0, Q)</span>
<span class="sd">        </span>
<span class="sd">        y_{t} = Z_{t} * x_{t} + v_{t},             v =  Normal(0, H)</span>
<span class="sd">		</span>
<span class="sd"> </span>
<span class="sd">    Durbin-Koopman algorithm</span>

<span class="sd">    .. math::			</span>
<span class="sd">		v_{t} &amp;= y_{t} - Z_{t} * x_{t}</span>
<span class="sd">        </span>
<span class="sd">		x_{t} &amp;= T_{t} * (x_{t-1} + K_{t} * v_{t}) + C_{t}</span>
<span class="sd">        </span>
<span class="sd">		F_{t} &amp;= H_{t} + Z_{t} * P_{t-1} * Z&#39;_{t}</span>
<span class="sd">        </span>
<span class="sd">		K_{t} &amp;= P_{t} * Z&#39;_{t} * F_{t}^{-1}</span>
<span class="sd">        </span>
<span class="sd">        L_{t} &amp;= K_{t} * Z_{t} </span>
<span class="sd">        </span>
<span class="sd">		P_{t+1} &amp;= T_{t} * P_{t} *L&#39;_{t-1} + Q_{t}		  </span>
<span class="sd">		</span>
<span class="sd"> </span>
<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the variables at t+1|t+1 step,</span>
<span class="sd">        xtilde: array, dtype=float</span>
<span class="sd">           is the variables at t|t+1 forecast step,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        v: array, dtype=float</span>
<span class="sd">           is the residual,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the predicted error covariance matrix,</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of measurement errors,</span>
<span class="sd">        Q: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of structural errors,</span>
<span class="sd">        K: 2Darray, dtype=float</span>
<span class="sd">           is the Kalman gain,</span>
<span class="sd">        C: array, dtype=float</span>
<span class="sd">           is the constant term matrix,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">            are the indices of non-missing observations,</span>
<span class="sd">        tol1: number, float</span>
<span class="sd">            Kalman tolerance for reciprocal condition number,</span>
<span class="sd">        tol2: number, float</span>
<span class="sd">            diffuse Kalman tolerance for reciprocal condition number (for Finf) and the rank of Pinf</span>
<span class="sd">      </span>
<span class="sd">    For details, see Durbin &amp; Koopman 2012, &quot;Time series Analysis by State Space Methods&quot; and</span>
<span class="sd">                 Koopman &amp; Durbin 2000, &quot;Fast Filtering and Smoothing For Multivariate State Space Models&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">iF</span> <span class="o">=</span> <span class="kc">None</span>  
            
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
         <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>
     
    <span class="n">ZZ</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>
    <span class="n">v</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
    <span class="n">F</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">K</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">PZI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
     
       
     <span class="c1">### --------------------------------------------------------- Standard Kalman Filter</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xn</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">x</span>  <span class="o">+</span> <span class="n">C</span>  
        <span class="n">P</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="n">F</span>   <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span>        <span class="c1"># pre-fit residual covariance</span>
        <span class="n">iF</span>  <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
        <span class="n">K</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span> 
        <span class="n">v</span>   <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">xn</span>
        <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="mi">0</span>
   
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">### Multivariate approach to Kalman filter</span>
        <span class="n">iF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
        <span class="c1"># measurement residual</span>
        <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">x</span>
        <span class="c1">### Multivariate approach to Kalman Filter</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">+</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span>      <span class="c1"># pre-fit residual covariance</span>
        <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>             <span class="c1"># matrix inverse  </span>
        <span class="n">PZI</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span>
        <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">PZI</span>                                     <span class="c1"># Kalman gain</span>
        <span class="n">xtilde</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">PZI</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>                               <span class="c1"># updated (a posteriori) state estimate eq (4.26) DK(2012)</span>
        <span class="n">xn</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span>  <span class="o">+</span> <span class="n">C</span>                                               <span class="c1"># predicted state estimate</span>
        <span class="n">L</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">ZZ</span>
        <span class="n">P</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="c1"># Log-likelihood of the observed data set</span>
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_meas</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
     
  
    <span class="k">return</span> <span class="n">xn</span><span class="p">,</span> <span class="n">xtilde</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">iF</span><span class="p">,</span> <span class="n">log_likelihood</span></div>

                                

<div class="viewcode-block" id="DK_Smoother">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.DK_Smoother">[docs]</a>
<span class="k">def</span> <span class="nf">DK_Smoother</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">iF</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">QRt</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement non-diffusive Durbin-Koopman smoother for state-space model.</span>
<span class="sd">    </span>
<span class="sd">    Durbin-Koopman smoothing algorithm is</span>
<span class="sd">                </span>
<span class="sd">    .. math::</span>
<span class="sd">        r_{t-1} &amp;= Z&#39;_{t}*F_{t}^{-1}*v_{t} + L&#39;_{t}**r_{t} </span>
<span class="sd">        </span>
<span class="sd">        r_{T} &amp;= 0 </span>
<span class="sd">        </span>
<span class="sd">        L_{t} &amp;= I - K_{t}*Z_{t}                                                          </span>
<span class="sd">        </span>
<span class="sd">    Smoothed variables</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">        s_{t} = x_{t} + P_{t}*r_{t-1}</span>
<span class="sd">              </span>
<span class="sd">	</span>
<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the updated state variables vector,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        F: 2D array, dtype=float</span>
<span class="sd">           is the residual covariance matrix,</span>
<span class="sd">        iF: 2D array, dtype=float</span>
<span class="sd">           is the inverse of matrix F,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the updated error covariance matrix,</span>
<span class="sd">        QRt: 2D array, dtype=float</span>
<span class="sd">           is the product of the covariance matrix of structural errors and shock matrix</span>
<span class="sd">        K: 2D array, dtype=float</span>
<span class="sd">           is the Kalman gain matrix,</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of measurement errors,</span>
<span class="sd">        r: array, dtype=float</span>
<span class="sd">           is the vector of one-step-back errors,</span>
<span class="sd">        v: array, dtype=float</span>
<span class="sd">           is the vector of one-step-ahead prediction errors,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">           are the indices of non-missing observations.</span>
<span class="sd">        </span>
<span class="sd">    For details, see Durbin &amp; Koopman (2012), &quot;Time series Analysis by State Space Methods&quot; and</span>
<span class="sd">    Koopman &amp; Durbin (2000), &quot;Fast Filtering and Smoothing For Multivariate State Space Models&quot; and</span>
<span class="sd">    Koopman &amp; Durbin (2003), in Journal of Time Series Analysis, vol. 24(1), pp. 85-98</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_meas</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_meas</span><span class="p">)</span>
    
    <span class="n">etahat</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">QRt</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">Z</span>
    <span class="c1"># Smooth estimate</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span>        
        <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r</span>  
        <span class="n">epsilonhat</span> <span class="o">=</span> <span class="n">H</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">P</span> <span class="o">@</span> <span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span> <span class="o">+</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span>                          <span class="c1"># eq (4.39) in DK(2012) </span>
        <span class="c1"># Smooth estimation of state variables disturbance</span>
        <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r</span>                                    <span class="c1"># DK (2012)</span>
        <span class="c1"># Smooth estimation of observation disturbance</span>
        <span class="n">epsilonhat</span> <span class="o">=</span>  <span class="n">H</span> <span class="o">@</span> <span class="p">(</span><span class="n">iF</span> <span class="o">@</span> <span class="n">v</span> <span class="o">-</span> <span class="n">K</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span><span class="p">)</span> 
        <span class="c1"># Smooth estimate</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">P</span> <span class="o">@</span> <span class="n">r</span>                                      <span class="c1"># eq (4.39) in DK(2012)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">xs</span>                                    <span class="c1"># Smooth estimation of observation disturbance</span>
 
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">etahat</span><span class="p">,</span><span class="n">epsilonhat</span></div>



<div class="viewcode-block" id="Durbin_Koopman_Non_Diffuse_Filter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Durbin_Koopman_Non_Diffuse_Filter">[docs]</a>
<span class="k">def</span> <span class="nf">Durbin_Koopman_Non_Diffuse_Filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xtilde</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bUnivariate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol1</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="n">tol2</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement non-diffusive Durbin &amp; Koopman version of Kalman filter algorithm for state-space model.</span>
<span class="sd">               </span>
<span class="sd">    State-space model:</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        x_{t} = T_{t} * x_{t-1} + C_{t}  + w_{t},  w = Normal(0, Q)</span>
<span class="sd">        </span>
<span class="sd">        y_{t} = Z_{t} * x_{t} + v_{t},             v = Normal(0, H)</span>
<span class="sd">		</span>
<span class="sd"> </span>
<span class="sd">    Durbin-Koopman algorithm</span>

<span class="sd">    .. math::			</span>
<span class="sd">		v_{t} &amp;= y_{t} - Z_{t} * x_{t}</span>
<span class="sd">        </span>
<span class="sd">		x_{t} &amp;= T_{t} * (x_{t-1} + K_{t} * v_{t}) + C_{t}</span>
<span class="sd">        </span>
<span class="sd">		F_{t} &amp;= H_{t} + Z_{t} * P_{t-1} * Z&#39;_{t}</span>
<span class="sd">        </span>
<span class="sd">		K_{t} &amp;= P_{t} * Z&#39;_{t} * F_{t}^{-1}</span>
<span class="sd">        </span>
<span class="sd">        L_{t} &amp;= K_{t} * Z_{t}</span>
<span class="sd">        </span>
<span class="sd">		P_{t+1} &amp;= T_{t} * P_{t} *L&#39;_{t-1} + Q_{t}		  </span>
<span class="sd">		</span>

<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the variables at t+1|t+1 step,</span>
<span class="sd">        xtilde: array, dtype=float</span>
<span class="sd">           is the variables at t|t+1 forecast step,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the predicted error covariance matrix,</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of measurement errors,</span>
<span class="sd">        Q: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of structural errors,</span>
<span class="sd">        C: array, dtype=float</span>
<span class="sd">           is the constant term matrix,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">           are the indices of non-missing observations,</span>
<span class="sd">        tol1: number, float</span>
<span class="sd">           Kalman tolerance for reciprocal condition number,</span>
<span class="sd">        tol2: number, float</span>
<span class="sd">           diffuse Kalman tolerance for reciprocal condition number (for Finf) and the rank of Pinf</span>
<span class="sd">      </span>
<span class="sd">    For details, see Durbin &amp; Koopman 2012, &quot;Time series Analysis by State Space Methods&quot; and</span>
<span class="sd">                 Koopman &amp; Durbin 2000, &quot;Fast Filtering and Smoothing For Multivariate State Space Models&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_meas</span>         <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">n_states</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>
    
    <span class="n">ZZ</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
    
    <span class="n">F</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">K</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">iF</span><span class="p">,</span><span class="n">P1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    
    <span class="c1">#P = sp.linalg.tril(P) + np.transpose(sp.linalg.tril(P,-1))  </span>
        
    <span class="c1"># Check if matrices Finf, Fstar are singular</span>
    <span class="n">bUnivariate</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">H</span><span class="o">+</span><span class="n">Z</span><span class="nd">@P@Z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol2</span>  
                 
    <span class="c1">### --------------------------------------------------------- Standard Kalman Filter</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span>  <span class="o">+</span> <span class="n">C</span>  
        <span class="n">P</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bUnivariate</span><span class="p">:</span>
            <span class="c1">### Multivariate approach to Kalman filter</span>
            <span class="n">iF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
            <span class="c1"># measurement residual</span>
            <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">x</span>
            <span class="c1">### Multivariate approach to Kalman Filter</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">+</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span>      <span class="c1"># pre-fit residual covariance</span>
            <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>             <span class="c1"># matrix inverse  </span>
            <span class="n">PZI</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span>
            <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">PZI</span>                                     <span class="c1"># Kalman gain</span>
            <span class="n">xtilde</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">PZI</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>                               <span class="c1"># updated (a posteriori) state estimate eq (4.26) DK(2012)</span>
            <span class="n">xn</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span>  <span class="o">+</span> <span class="n">C</span>                                               <span class="c1"># predicted state estimate</span>
            <span class="n">L</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">ZZ</span>
            <span class="n">P</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
            <span class="n">log_likelihood</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> 
             
        <span class="k">else</span><span class="p">:</span>
            
            <span class="c1">### Univariate approach to Kalman filter</span>
            <span class="n">xtilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_non_missing</span><span class="p">:</span>
                <span class="n">Z_i</span>  <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">xtilde</span>                                      <span class="c1"># measurement residual</span>
                <span class="n">F_i</span>  <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">K_i</span>  <span class="o">=</span> <span class="n">K</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span>
                <span class="k">if</span> <span class="n">F_i</span> <span class="o">&gt;</span> <span class="n">tol1</span><span class="p">:</span>
                    <span class="n">xtilde</span> <span class="o">+=</span> <span class="n">K_i</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">F_i</span> 
                    <span class="n">P</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">K_i</span><span class="p">,</span><span class="n">K_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">F_i</span>
                    <span class="n">log_likelihood</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">F_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span>  <span class="n">F_i</span>  
  
            <span class="c1"># Transition equations</span>
            <span class="n">xn</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span> <span class="o">+</span> <span class="n">C</span> <span class="c1"># predicted state estimate</span>
            <span class="n">P</span> <span class="o">=</span>  <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>  <span class="o">+</span> <span class="n">Q</span>                                      
                   
          
    <span class="c1"># Log-likelihood of the observed data set</span>
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_meas</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_likelihood</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iF</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">H</span><span class="o">+</span><span class="n">Z</span><span class="nd">@P@Z</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span>
        
    <span class="k">return</span> <span class="n">xn</span><span class="p">,</span> <span class="n">xtilde</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span>  <span class="n">iF</span><span class="p">,</span> <span class="n">bUnivariate</span><span class="p">,</span> <span class="n">log_likelihood</span></div>

                

<div class="viewcode-block" id="Durbin_Koopman_Non_Diffuse_Smoother">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Durbin_Koopman_Non_Diffuse_Smoother">[docs]</a>
<span class="k">def</span> <span class="nf">Durbin_Koopman_Non_Diffuse_Smoother</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">iF</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">P1</span><span class="p">,</span><span class="n">QRt</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bUnivariate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span><span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement non-diffusive Durbin-Koopman smoother for state-space model.</span>
<span class="sd">    </span>
<span class="sd">    Durbin-Koopman algorithm is</span>
<span class="sd">                </span>
<span class="sd">    .. math::</span>
<span class="sd">        r_{t-1} &amp;= Z&#39;_{t}*F_{t}^{-1}*v_{t} + L&#39;_{t}**r_{t}</span>
<span class="sd">        </span>
<span class="sd">        r_{T} &amp;= 0</span>
<span class="sd">        </span>
<span class="sd">        N_{t-1} &amp;= Z&#39;_{t}*F_{t}^{-1}*Z_{t} + L&#39;_{t}*N_{t}*L{t}</span>
<span class="sd">        </span>
<span class="sd">        N_{T} &amp;= 0</span>
<span class="sd">        </span>
<span class="sd">        L_{t} &amp;= I - K_{t}*Z_{t}                                                          </span>
<span class="sd">        </span>
<span class="sd">    Smoothed variables</span>
<span class="sd">           </span>
<span class="sd">    .. math::</span>
<span class="sd">        s_{t} = x_{t} + P_{t}*r_{t-1}</span>
<span class="sd">        </span>
<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the predicted variables vector,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        F: 2D array, dtype=float</span>
<span class="sd">           is the residual covariance matrix,</span>
<span class="sd">        iF: 2D array, dtype=float</span>
<span class="sd">           is the inverse of matrix F,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the updated error covariance matrix,</span>
<span class="sd">        QRt: 2D array, dtype=float</span>
<span class="sd">           is the product of the covariance matrix of structural errors and shock matrix,</span>
<span class="sd">        K:2D array, dtype=float</span>
<span class="sd">           is the Kalman gain matrix,</span>
<span class="sd">        r: array, dtype=float</span>
<span class="sd">           is the vector of one-step-back errors,</span>
<span class="sd">        v: array, dtype=float</span>
<span class="sd">           is the vector of one-step-ahead prediction errors,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">           are the indices of non-missing observations.</span>
<span class="sd">        bUnivariate: bool</span>
<span class="sd">           True if univariate Kalman filter is used and False otherwise,</span>
<span class="sd">        tol: number, float</span>
<span class="sd">           is Kalman tolerance for reciprocal condition number.</span>
<span class="sd">        </span>
<span class="sd">    For details, see Durbin &amp; Koopman (2012), &quot;Time series Analysis by State Space Methods&quot; and</span>
<span class="sd">    Koopman &amp; Durbin (2000), &quot;Fast Filtering and Smoothing For Multivariate State Space Models&quot; and</span>
<span class="sd">    Koopman &amp; Durbin (2003), in Journal of Time Series Analysis, vol. 24(1), pp. 85-98 </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>
    <span class="n">rev_ind_non_missing</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span>
    
    <span class="n">ZZ</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>
    <span class="n">etahat</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">QRt</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">ZZ</span>
           
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bUnivariate</span><span class="p">:</span>              <span class="c1">#-----------------------------  Mutivariate smooting KF estimates</span>
        <span class="c1"># Smooth estimate</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">,:]</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">+</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span>               <span class="c1"># eq (4.39) in DK(2012)  </span>
        <span class="c1"># Smooth estimate</span>
        <span class="n">xhat</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">P</span> <span class="o">@</span> <span class="n">r</span>                                             <span class="c1"># eq (4.39) in DK(2012)</span>
        <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r</span>                                             <span class="c1"># DK (2012)</span>
    
    <span class="k">else</span><span class="p">:</span>                            <span class="c1">#-----------------------------  Univariate approach to smooting KF estimates</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rev_ind_non_missing</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="n">L_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">K</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">L_i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span>             <span class="c1"># DK (2012), 6.15, equation for r_{i-1}</span>
                                                                     <span class="c1"># DK (2012), below (6.15), r_{t-1}=r_{0}</span>
        <span class="n">xhat</span>  <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">P1</span> <span class="o">@</span> <span class="n">r</span>                                           <span class="c1"># DK (2012), eq (6.15)</span>
        <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r</span>                                             <span class="c1"># DK (2012), eq. 4.63</span>
        <span class="n">r</span>   <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span>                                                <span class="c1"># Smooth estimation of observation disturbance </span>
        
    <span class="c1"># Smooth estimation of observation disturbance</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">xhat</span>           
                
    <span class="k">return</span> <span class="n">xhat</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">etahat</span> </div>



<div class="viewcode-block" id="Durbin_Koopman_Diffuse_Filter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Durbin_Koopman_Diffuse_Filter">[docs]</a>
<span class="k">def</span> <span class="nf">Durbin_Koopman_Diffuse_Filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xtilde</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bUnivariate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Pstar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Pinf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol1</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="n">tol2</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement diffuse Durbin &amp; Koopman version of Kalman filter algorithm for state-space model.</span>
<span class="sd">               </span>
<span class="sd">    State-space model:</span>

<span class="sd">    .. math::</span>
<span class="sd">        x_{t} = T_{t} * x_{t-1} + C_{t}  + w_{t},  w = Normal(0, Q)</span>
<span class="sd">        </span>
<span class="sd">        y_{t} = Z_{t} * x_{t} + v_{t}, v = Normal(0, H)</span>
<span class="sd">		</span>
<span class="sd"> </span>
<span class="sd">    Durbin-Koopman algorithm</span>

<span class="sd">    .. math::			</span>
<span class="sd">		v_{t} &amp;= y_{t} - Z_{t} * x_{t}</span>
<span class="sd">        </span>
<span class="sd">		x_{t} &amp;= T_{t} * (x_{t-1} + K_{t} * v_{t}) + C_{t}</span>
<span class="sd">        </span>
<span class="sd">		F_{t} &amp;= H_{t} + Z_{t} * P_{t-1} * Z&#39;_{t}</span>
<span class="sd">        </span>
<span class="sd">		K_{t} &amp;= P_{t} * Z&#39;_{t} * F_{t}^{-1}</span>
<span class="sd">        </span>
<span class="sd">        L_{t} &amp;= K_{t} * Z_{t}</span>
<span class="sd">        </span>
<span class="sd">		P_{t+1} &amp;= T_{t} * P_{t} *L&#39;_{t-1} + Q_{t}		  </span>
<span class="sd">		</span>
<span class="sd">    .. note::</span>
<span class="sd">        Translated from Dynare Matlab code.</span>
<span class="sd">        </span>
<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the state variables,</span>
<span class="sd">        xtilde: array, dtype=float</span>
<span class="sd">           is the variables at t|t+1 forecast step,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the predicted error covariance matrix,</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of measurement errors,</span>
<span class="sd">        Q: 2D array, dtype=float</span>
<span class="sd">           is the covariance matrix of structural errors,</span>
<span class="sd">        C: array, dtype=float</span>
<span class="sd">           is the constant term matrix,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">           are the indices of non-missing observations,</span>
<span class="sd">        Pstar: 2D array, dtype=float</span>
<span class="sd">               is the finite part of the predicted error covariance matrix,</span>
<span class="sd">        Pinf: 2D array, dtype=float</span>
<span class="sd">              is the infinite part of the predicted error covariance matrix,</span>
<span class="sd">        tol1: number, float</span>
<span class="sd">            Kalman tolerance for reciprocal condition number,</span>
<span class="sd">        tol2: number, float</span>
<span class="sd">            diffuse Kalman tolerance for reciprocal condition number (for Finf) and the rank of Pinf</span>
<span class="sd">      </span>
<span class="sd">    For details, see Durbin &amp; Koopman 2012, &quot;Time series Analysis by State Space Methods&quot; and</span>
<span class="sd">                 Koopman &amp; Durbin 2000, &quot;Fast Filtering and Smoothing For Multivariate State Space Models&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_meas</span>         <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">n_states</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">Finf_singular</span>  <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>
    
    <span class="n">ZZ</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
    
    <span class="n">F</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">Finf</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">Fstar</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">K</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">Kstar</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">Kinf</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
    <span class="n">iF</span><span class="p">,</span><span class="n">Linf</span><span class="p">,</span><span class="n">Lstar</span><span class="p">,</span><span class="n">P1</span><span class="p">,</span><span class="n">Pstar1</span><span class="p">,</span><span class="n">Pinf1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    
    <span class="c1">#P = sp.linalg.tril(P) + np.transpose(sp.linalg.tril(P,-1))  </span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        
    <span class="c1"># Check if matrices Finf, Fstar are singular</span>
    <span class="n">diffuse</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Pinf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Pstar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bUnivariate</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">Z</span><span class="nd">@Pinf</span><span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol2</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">H</span><span class="o">+</span><span class="n">Z</span><span class="nd">@Pstar</span><span class="o">@</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol2</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Pinf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bUnivariate</span><span class="p">:</span>
            <span class="n">rank</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">Z</span><span class="nd">@Pinf@Z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">tol1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rank</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">Pinf</span><span class="p">,</span><span class="n">tol1</span><span class="p">)</span>
        <span class="n">diffuse</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  
    <span class="c1">### --------------------------------------------------------- Standard Kalman Filter</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span>  <span class="o">+</span> <span class="n">C</span>  
        <span class="n">L</span>  <span class="o">=</span> <span class="n">T</span>
        <span class="n">Pstar</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pstar</span><span class="p">)</span>
        <span class="n">Pinf</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diffuse</span><span class="p">:</span>
            <span class="n">Kinf</span> <span class="o">=</span> <span class="n">Kstar</span> <span class="o">=</span> <span class="n">Linf</span> <span class="o">=</span> <span class="n">Lstar</span> <span class="o">=</span> <span class="n">Finf</span> <span class="o">=</span> <span class="n">Fstar</span> <span class="o">=</span> <span class="kc">None</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bUnivariate</span><span class="p">:</span>
                <span class="n">iF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_meas</span><span class="p">,</span><span class="n">n_meas</span><span class="p">))</span>
                <span class="c1">### Multivariate approach to Kalman filter</span>
                <span class="c1"># measurement residual</span>
                <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">x</span>
                <span class="c1">### Multivariate approach to Kalman Filter</span>
                <span class="n">F</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">+</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span>      <span class="c1"># pre-fit residual covariance</span>
                <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>             <span class="c1"># matrix inverse  </span>
                <span class="n">PZI</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span>
                <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">PZI</span>                                     <span class="c1"># Kalman gain</span>
                <span class="n">xtilde</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">PZI</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>                               <span class="c1"># updated (a posteriori) state estimate eq (4.26) DK(2012)</span>
                <span class="n">xn</span>     <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span>  <span class="o">+</span> <span class="n">C</span>                                            <span class="c1"># predicted state estimate</span>
                <span class="n">L</span>      <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">ZZ</span>
                <span class="n">Pstar</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
                <span class="n">P</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pstar</span><span class="p">)</span>
                <span class="n">Pinf</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span>
                <span class="n">log_likelihood</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span> <span class="o">@</span> <span class="n">iF</span> <span class="o">@</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> 
                 
            <span class="k">else</span><span class="p">:</span>
                
                <span class="c1">### Univariate approach to Kalman filter</span>
                <span class="n">xtilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_non_missing</span><span class="p">:</span>
                    <span class="n">Z_i</span>  <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">xtilde</span>                        <span class="c1"># measurement residual</span>
                    <span class="n">F_i</span>  <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">K_i</span>  <span class="o">=</span> <span class="n">K</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span>
                    <span class="k">if</span> <span class="n">F_i</span> <span class="o">&gt;</span> <span class="n">tol1</span><span class="p">:</span>
                        <span class="n">xtilde</span> <span class="o">+=</span> <span class="n">K_i</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">F_i</span> 
                        <span class="n">P</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">K_i</span><span class="p">,</span><span class="n">K_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">F_i</span>
                        <span class="n">log_likelihood</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">F_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span>  <span class="n">F_i</span>  
        
                <span class="c1"># Transition equations</span>
                <span class="n">xn</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span> <span class="o">+</span> <span class="n">C</span> <span class="c1"># predicted state estimate</span>
                <span class="n">Pstar</span> <span class="o">=</span>  <span class="n">T</span> <span class="o">@</span> <span class="n">P</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>  <span class="o">+</span> <span class="n">Q</span>   
                <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pstar</span><span class="p">)</span>  
                <span class="n">Pinf</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span>                                 
                   
                
        <span class="c1">### --------------------------------------------------------- Diffuse Kalman Filter</span>
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bUnivariate</span><span class="p">:</span> 
                <span class="c1">### Multivariate approach to KF</span>
                <span class="c1"># measurement residual</span>
                <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">x</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">xtilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">Finf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span>  <span class="o">=</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">Pinf</span>  <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span>
                <span class="n">Fstar</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">H</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> 
                <span class="c1"># Check if matrix Finf is singular</span>
                <span class="k">if</span> <span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Finf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol1</span><span class="p">:</span>
                    <span class="c1"># Matrix Finf is singular</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Finf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol1</span><span class="p">):</span> 
                        <span class="c1"># The univariate diffuse Kalman filter should be used instead.</span>
                        <span class="n">bUnivariate</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">Finf_singular</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Fstar</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)])</span> <span class="o">&lt;</span> <span class="n">tol2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Fstar</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol2</span><span class="p">):</span> 
                                <span class="c1"># The univariate diffuse Kalman filter should be used.</span>
                                <span class="n">bUnivariate</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>                                                 <span class="c1">#rank 0</span>
                                <span class="n">Pinf</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>                           <span class="c1"># eq (5.16)</span>
                                <span class="n">Pstar</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
                                <span class="n">xn</span>     <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">x</span> <span class="o">+</span> <span class="n">C</span>  
                                <span class="n">log_likelihood</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Finf</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span> <span class="o">@</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Finf</span><span class="p">)</span> <span class="o">@</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> 
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># Matrix Fstar is positive definite</span>
                            <span class="n">iFstar</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Fstar</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)])</span> 
                            <span class="n">Kstar</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iFstar</span>      <span class="c1"># K0 eq (5.15) in DK(2012)</span>
                            <span class="n">Lstar</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Kstar</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">ZZ</span>        <span class="c1"># L0 eq (5.15)</span>
                            <span class="n">Pinf</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>                               <span class="c1"># eq (5.16)</span>
                            <span class="n">Pstar</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">Lstar</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>
                            <span class="n">P</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pstar</span><span class="p">)</span>
                            <span class="n">x</span>     <span class="o">+=</span> <span class="n">Kstar</span> <span class="o">@</span> <span class="n">v</span>
                            <span class="n">xn</span>     <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">x</span> <span class="o">+</span> <span class="n">C</span>  
                            <span class="n">log_likelihood</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Fstar</span><span class="p">))</span> <span class="o">+</span> <span class="n">v</span> <span class="o">@</span> <span class="n">iFstar</span> <span class="o">@</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span>                          
                        
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>  <span class="c1"># Matrix Finf is positive definite</span>
                    <span class="n">iFinf</span>  <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Finf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)])</span> 
                    <span class="n">Kinf</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span>   <span class="o">=</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iFinf</span>                 <span class="c1"># K0 eq (5.12)</span>
                    <span class="n">Linf</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">T</span> <span class="nd">@Kinf</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">ZZ</span>                  <span class="c1"># L0 eq (5.12)</span>
                    <span class="n">Kstar</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">Pstar</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">Kinf</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> \
                        <span class="o">@</span> <span class="n">Fstar</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)]</span> <span class="p">)</span> <span class="o">@</span> <span class="n">iFinf</span>  <span class="c1"># K1 in eq (5.12)  </span>
                    <span class="n">Pstar</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">Linf</span><span class="o">.</span><span class="n">T</span> \
                           <span class="o">-</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Kinf</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">Finf</span> <span class="o">@</span> <span class="n">Kstar</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>  <span class="c1"># eq (5.14)</span>
                    <span class="n">Pinf</span>   <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">Linf</span><span class="o">.</span><span class="n">T</span>                                    <span class="c1"># eq (5.14) </span>
                    <span class="n">P</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pstar</span><span class="p">)</span>
                    <span class="n">xtilde</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">Kinf</span> <span class="o">@</span> <span class="n">v</span> 
                    <span class="n">xn</span>     <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span>  <span class="o">+</span>  <span class="n">C</span>  
                    <span class="n">log_likelihood</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">Finf</span><span class="p">))</span>  <span class="o">+</span> <span class="n">v</span> <span class="o">@</span> <span class="n">iFinf</span> <span class="o">@</span> <span class="n">v</span>
            
            <span class="k">if</span> <span class="n">bUnivariate</span><span class="p">:</span> 
                <span class="c1">### Univariate approach to KF</span>
                <span class="n">Fstar</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_meas</span><span class="p">)</span>
                <span class="n">Finf</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_meas</span><span class="p">)</span>
                <span class="n">Pstar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pstar</span><span class="p">)</span>
                <span class="n">Pinf1</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pinf</span><span class="p">)</span>
                <span class="n">xtilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_non_missing</span><span class="p">:</span>
                    <span class="n">Z_i</span>  <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">xtilde</span>                                 <span class="c1"># measurement residual</span>
                    <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fstar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>             <span class="c1"># eq (15) in KD(2000)</span>
                    <span class="n">Finf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span>                        <span class="c1"># eq (15)</span>
                    <span class="n">K</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kstar</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kstar_i</span> <span class="o">=</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span>               <span class="c1"># eq (15)</span>
                    <span class="n">Kinf</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kinf_i</span>  <span class="o">=</span> <span class="n">Pinf</span>  <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span>                             <span class="c1"># eq (15)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Finf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">tol1</span><span class="p">:</span>
                        <span class="n">Kinf_Finf</span> <span class="o">=</span> <span class="n">Kinf_i</span> <span class="o">/</span> <span class="n">Finf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">xtilde</span> <span class="o">+=</span> <span class="n">Kinf_Finf</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>                                    <span class="c1"># eq (16)</span>
                        <span class="n">Pstar</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kinf_i</span><span class="p">,</span><span class="n">Kinf_Finf</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fstar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">Finf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  \
                               <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kstar_i</span><span class="p">,</span><span class="n">Kinf_Finf</span><span class="p">)</span> \
                               <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kinf_Finf</span><span class="p">,</span><span class="n">Kstar_i</span><span class="p">)</span>
                        <span class="n">Pinf</span>  <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kinf_i</span><span class="p">,</span><span class="n">Kinf_i</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="n">Finf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>                    <span class="c1"># eq (16)</span>
                        <span class="n">log_likelihood</span>   <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Finf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Finf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  
                    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fstar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">tol2</span><span class="p">:</span>
                        <span class="n">xtilde</span> <span class="o">+=</span> <span class="n">Kstar_i</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">Fstar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>                            <span class="c1"># eq (17)</span>
                        <span class="n">Pstar</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kstar_i</span><span class="p">,</span><span class="n">Kstar_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fstar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>                  <span class="c1"># eq (17)</span>
                        <span class="n">log_likelihood</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Fstar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">Fstar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>                          
                        
                      
                <span class="c1"># Transition equations</span>
                <span class="n">xn</span>    <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">xtilde</span> <span class="o">+</span> <span class="n">C</span>  
                <span class="n">Pstar</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Q</span>                                           <span class="c1"># eq (18)  </span>
                <span class="n">Pinf</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>                                                <span class="c1"># eq (18)</span>
                <span class="n">P</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Pstar</span><span class="p">)</span>   
    
            
            <span class="k">if</span> <span class="n">bUnivariate</span><span class="p">:</span>
                <span class="n">rank</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">Z</span><span class="nd">@Pinf@Z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">tol1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rank</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">Pinf</span><span class="p">,</span><span class="n">tol1</span><span class="p">)</span>
        
    <span class="c1"># Log-likelihood of the observed data set</span>
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_meas</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_likelihood</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">iF</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iF</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">H</span><span class="o">+</span><span class="n">Z</span><span class="nd">@P@Z</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span>
        
    <span class="k">return</span> <span class="n">xn</span><span class="p">,</span> <span class="n">xtilde</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Kinf</span><span class="p">,</span> <span class="n">Kstar</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">Linf</span><span class="p">,</span> <span class="n">Lstar</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Finf</span><span class="p">,</span> <span class="n">Fstar</span><span class="p">,</span> <span class="n">iF</span><span class="p">,</span> <span class="n">log_likelihood</span><span class="p">,</span> <span class="n">diffuse</span><span class="p">,</span> <span class="n">Pstar</span><span class="p">,</span> <span class="n">Pinf</span><span class="p">,</span> <span class="n">Pstar1</span><span class="p">,</span> <span class="n">Pinf1</span><span class="p">,</span> <span class="n">Finf_singular</span><span class="p">,</span> <span class="n">bUnivariate</span></div>

                

<div class="viewcode-block" id="Durbin_Koopman_Diffuse_Smoother">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.filters.html#snowdrop.src.numeric.filters.filters.Durbin_Koopman_Diffuse_Smoother">[docs]</a>
<span class="k">def</span> <span class="nf">Durbin_Koopman_Diffuse_Smoother</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">iF</span><span class="p">,</span><span class="n">QRt</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">Kstar</span><span class="p">,</span><span class="n">Kinf</span><span class="p">,</span><span class="n">H</span><span class="p">,</span>
                                    <span class="n">P</span><span class="p">,</span><span class="n">P1</span><span class="p">,</span><span class="n">Pstar</span><span class="p">,</span><span class="n">Pinf</span><span class="p">,</span><span class="n">Pstar1</span><span class="p">,</span><span class="n">Pinf1</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span>
                                    <span class="n">Linf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Lstar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">diffuse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">Finf_singular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bUnivariate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">tol1</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span><span class="n">tol2</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span><span class="n">t</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement diffuse Durbin-Koopman smoother for state-space model.</span>
<span class="sd">    </span>
<span class="sd">    Durbin-Koopman algorithm is</span>
<span class="sd">                </span>
<span class="sd">    .. math::</span>
<span class="sd">        r_{t-1} &amp;= Z&#39;_{t}*F_{t}^{-1}*v_{t} + L&#39;_{t}**r_{t}</span>
<span class="sd">        </span>
<span class="sd">        r_{T} &amp;= 0</span>
<span class="sd">        </span>
<span class="sd">        L_{t} &amp;= I - K_{t}*Z_{t}                                                          </span>
<span class="sd">        </span>
<span class="sd">    Smoothed variables</span>
<span class="sd">          </span>
<span class="sd">    .. math:: </span>
<span class="sd">        s_{t} = x_{t} + P_{t}*r_{t-1}</span>
<span class="sd">              </span>
<span class="sd">    .. note::</span>
<span class="sd">        Translated from Dynare Matlab code.</span>
<span class="sd">        </span>
<span class="sd">    Args:</span>
<span class="sd">        x: array, dtype=float</span>
<span class="sd">           is the predicted state variables vector,</span>
<span class="sd">        y: array, dtype=float</span>
<span class="sd">           is the observation variables,</span>
<span class="sd">        T: 2D array, dtype=float</span>
<span class="sd">           is the state-transition matrix,</span>
<span class="sd">        Z: 2D array, dtype=float</span>
<span class="sd">           is the observation matrix,</span>
<span class="sd">        F: 2D array, dtype=float</span>
<span class="sd">           is the residual covariance matrix,</span>
<span class="sd">        iF: 2D array, dtype=float</span>
<span class="sd">           is the inverse of matrix F,</span>
<span class="sd">        QRt: 2D array, dtype=float</span>
<span class="sd">           is the product of the covariance matrix of structural errors and shock matrix</span>
<span class="sd">        K: 2D array, dtype=float</span>
<span class="sd">           is the Kalman gain matrix,</span>
<span class="sd">        Kinf: 2D array, dtype=float</span>
<span class="sd">           is the infinite part of the Kalman gain matrix,</span>
<span class="sd">        Kstar: 2D array, dtype=float</span>
<span class="sd">           is the finite part of the Kalman gain matrix,</span>
<span class="sd">        H: 2D array, dtype=float</span>
<span class="sd">           is the observation errors covariance matrix,</span>
<span class="sd">        P: 2D array, dtype=float</span>
<span class="sd">           is the updated error covariance matrix P,</span>
<span class="sd">        P1:2D array, dtype=float</span>
<span class="sd">           is the updated error covariance matrix P1,</span>
<span class="sd">        Pstar: 2D array, dtype=float</span>
<span class="sd">           is the finite part of P matrix,</span>
<span class="sd">        Pinf: 2D array, dtype=float</span>
<span class="sd">           is the infinite part of P matrix,</span>
<span class="sd">        Pstar1: 2D array, dtype=float</span>
<span class="sd">           is the finite part of P1 matrix,</span>
<span class="sd">        Pinf1: 2D array, dtype=float</span>
<span class="sd">           is the infinite part of P1 matrix,</span>
<span class="sd">        ind_non_missing: array, dtype=int</span>
<span class="sd">           are the indices of non-missing observations.</span>
<span class="sd">        v: array, dtype=float</span>
<span class="sd">           is the vector of one-step-ahead prediction errors,</span>
<span class="sd">        r: array, dtype=float</span>
<span class="sd">           is  a smoothed state vector,</span>
<span class="sd">        r0: array, dtype=float</span>
<span class="sd">           is zero approximation in a Taylor expansion of a smoothed state vector,</span>
<span class="sd">        r1: array, dtype=float</span>
<span class="sd">           is the first approximation in a Taylor expansion of a smoothed state vector,</span>
<span class="sd">        Pstar: 2D array, dtype=float</span>
<span class="sd">           is the finite part of the predicted error covariance matrix,</span>
<span class="sd">        Pinf: 2D array, dtype=float</span>
<span class="sd">           is the infinite part of the predicted error covariance matrix,</span>
<span class="sd">        Finf_singular: bool</span>
<span class="sd">           True if Finf is a singular matrix and False otherwise,</span>
<span class="sd">        bUnivariate: bool</span>
<span class="sd">           True if univariate Kalman filter is used and False otherwise,</span>
<span class="sd">        tol1: number, float</span>
<span class="sd">           is Kalman tolerance for reciprocal condition number,</span>
<span class="sd">        tol2: number, float</span>
<span class="sd">           is diffuse Kalman tolerance for reciprocal condition number (for Finf) and the rank of Pinf</span>
<span class="sd">        </span>
<span class="sd">    For details, see Durbin &amp; Koopman (2012), &quot;Time series Analysis by State Space Methods&quot; and</span>
<span class="sd">    Koopman &amp; Durbin (2000), &quot;Fast Filtering and Smoothing For Multivariate State Space Models&quot; and</span>
<span class="sd">    Koopman &amp; Durbin (2003), in Journal of Time Series Analysis, vol. 24(1), pp. 85-98)</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">n_meas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ind_non_missing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Indeces of non-missing observations are not defined - resetting it.&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_meas</span><span class="p">)</span>
    <span class="n">rev_ind_non_missing</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span>
    
    <span class="n">ZZ</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>
    <span class="n">Finf</span> <span class="o">=</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Fstar</span> <span class="o">=</span> <span class="n">ZZ</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">T</span><span class="nd">@K</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">@</span> <span class="n">ZZ</span>
    <span class="n">etahat</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">QRt</span><span class="p">)</span>
       
    <span class="k">if</span> <span class="ow">not</span> <span class="n">diffuse</span><span class="p">:</span>                      <span class="c1"># Standard Kalman smoother</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bUnivariate</span><span class="p">:</span>              <span class="c1">#-----------------------------  Mutivariate smooting KF estimates</span>
            <span class="c1"># Smooth estimate</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iF</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">,:]</span> <span class="o">@</span> <span class="n">v</span> <span class="o">+</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span>               <span class="c1"># eq (4.39) in DK(2012)  </span>
            <span class="c1"># Smooth estimate</span>
            <span class="n">xhat</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">P</span> <span class="o">@</span> <span class="n">r</span>                                             <span class="c1"># eq (4.39) in DK(2012)</span>
            <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r</span>                                             <span class="c1"># DK (2012)</span>
        
        <span class="k">else</span><span class="p">:</span>                            <span class="c1">#-----------------------------  Univariate approach to smooting KF estimates</span>
    
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rev_ind_non_missing</span><span class="p">:</span> 
                    <span class="n">K_i</span> <span class="o">=</span> <span class="n">K</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">&gt;</span> <span class="n">tol1</span><span class="p">:</span>
                        <span class="n">L_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">K_i</span><span class="p">,</span><span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">L_i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r</span>             <span class="c1"># DK (2012), 6.15, equation for r_{i-1}</span>
                                                                         <span class="c1"># DK (2012), below (6.15), r_{t-1}=r_{0}</span>
            <span class="n">xhat</span>  <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">P1</span> <span class="o">@</span> <span class="n">r</span>                                           <span class="c1"># DK (2012), eq (6.15)</span>
            <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r</span>                                               <span class="c1"># Smooth estimation of observation disturbance </span>
            
      
    <span class="k">else</span><span class="p">:</span>                                <span class="c1">#-----------------------------------&gt;  Diffuse Filter: time is within diffuse periods </span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bUnivariate</span><span class="p">:</span>              <span class="c1">#------------------------------------  Mutivariate smooting KF estimates</span>
 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">Linf</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Finf_singular</span><span class="p">:</span>
                    <span class="n">iFinf</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Finf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)])</span>
                    <span class="n">r0</span>   <span class="o">=</span> <span class="n">Linf</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r0</span>                                          <span class="c1"># DK (2012), eq (5.21) where L^(0) is named Linf</span>
                    <span class="n">r1</span>   <span class="o">=</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">iFinf</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span>  \
                         <span class="o">-</span> <span class="n">Kstar</span><span class="p">[:,</span><span class="n">ind_non_missing</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r0</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="n">Linf</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r1</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iFstar</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Fstar</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind_non_missing</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="p">)])</span>
                    <span class="n">r0</span>  <span class="o">=</span> <span class="n">ZZ</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">iFstar</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="n">ind_non_missing</span><span class="p">]</span> <span class="o">-</span> <span class="n">Lstar</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r0</span>     <span class="c1"># DK (2003), eq (14)</span>
                    <span class="n">r1</span>  <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r1</span>                                              <span class="c1"># DK (2003), eq (14)</span>
                   
                <span class="n">xhat</span>  <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">r1</span>                              <span class="c1"># DK (2012), eq (5.23)                                            # Smooth estimation of observation disturbance</span>
                <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r0</span>                                               <span class="c1"># DK (2012), p. 135    </span>
                
        <span class="k">else</span><span class="p">:</span>                            <span class="c1">#------------------------------------  Univariate approach to smooting KF estimates</span>
                
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rev_ind_non_missing</span><span class="p">:</span>
                <span class="n">Z_i</span>     <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">Fstar_i</span> <span class="o">=</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">Pstar</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>                          <span class="c1"># eq (15) in KD(2000)</span>
                <span class="n">Finf_i</span>  <span class="o">=</span> <span class="n">Z_i</span> <span class="o">@</span> <span class="n">Pinf</span> <span class="o">@</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span>                                    <span class="c1"># eq (15)</span>
                <span class="n">Kstar_i</span> <span class="o">=</span> <span class="n">Kstar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>                                         <span class="c1"># eq (15)</span>
                <span class="n">Kinf_i</span>  <span class="o">=</span> <span class="n">Kinf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Finf_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol1</span><span class="p">:</span>
                    <span class="n">Linf_i</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kinf_i</span><span class="p">,</span><span class="n">Z_i</span><span class="p">)</span><span class="o">/</span><span class="n">Finf_i</span>
                    <span class="n">Lstar_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kinf_i</span><span class="o">*</span><span class="n">Fstar_i</span><span class="o">/</span><span class="n">Finf_i</span><span class="o">-</span><span class="n">Kstar_i</span><span class="p">,</span> <span class="n">Z_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">Finf_i</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">Finf_i</span> <span class="o">+</span> <span class="n">Lstar_i</span> <span class="o">@</span> <span class="n">r0</span>    \
                       <span class="o">+</span> <span class="n">Linf_i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r1</span>                                          <span class="c1"># KD (2000), eq. (25) for r_1</span>
                    <span class="n">r0</span> <span class="o">=</span> <span class="n">Linf_i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r0</span>  
                <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fstar_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol2</span><span class="p">:</span>                                       <span class="c1"># this step needed when Finf == 0</span>
                    <span class="n">L_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">Kstar_i</span><span class="p">,</span><span class="n">Z_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fstar_i</span>
                    <span class="n">r0</span>  <span class="o">=</span> <span class="n">Z_i</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">Fstar_i</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">L_i</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">r0</span>                   <span class="c1"># propagate r0 and keep r1 fixed</span>
                    
            <span class="n">xhat</span>  <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">Pstar1</span> <span class="o">@</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">Pinf1</span> <span class="o">@</span> <span class="n">r1</span>                                <span class="c1"># DK (2012), eq (5.23)</span>
            <span class="n">etahat</span> <span class="o">=</span> <span class="n">QRt</span> <span class="o">@</span> <span class="n">r0</span>                                                   <span class="c1"># DK (2012)</span>
            <span class="n">r0</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">r0</span>
            <span class="n">r1</span>  <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">r1</span>
            
    <span class="c1"># Smooth estimation of observation disturbance</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">xhat</span>           
        
    <span class="k">return</span> <span class="n">xhat</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r0</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">etahat</span> </div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The test of implementation of Kalman filter for state-space model:</span>
<span class="sd">         </span>
<span class="sd">    .. math::</span>
<span class="sd">        a(t+1) = T * a(t) + eta(t),  eta(t) ~ N(0,Q)</span>
<span class="sd">        </span>
<span class="sd">        y(t) = Z * a(t) + eps(t),  eps(t) ~ N(0,H)</span>
<span class="sd">        </span>
<span class="sd">        a(0) ~ N(a0, P0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="c1"># Parameters</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.1</span>
    
    <span class="c1"># Example dataset</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">nobs</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">nobs</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nobs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nobs</span><span class="p">)</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="c1"># State-Space</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">phi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">Q</span>  
    
    <span class="n">ind_non_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">yk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Run the Kalman filter</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nobs</span><span class="p">):</span>
        <span class="n">xk</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">Q</span> <span class="o">=</span> <span class="n">Kalman_Filter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span><span class="n">ind_non_missing</span><span class="o">=</span><span class="n">ind_non_missing</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">yk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
        
    <span class="n">yk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yk</span><span class="p">)</span>
    <span class="c1"># Run the HP filter </span>
    <span class="n">yf</span> <span class="o">=</span> <span class="n">LRXfilter</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1600</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">yk</span><span class="p">)</span>
             
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="n">x</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Solution&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yk</span><span class="p">)),</span><span class="n">yk</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kalman Filter&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yf</span><span class="p">)),</span><span class="n">yf</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;HP Filter&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Filters&#39;</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">Python Platform</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/modules.html">snowdrop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../info.html">Python Platform</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Alexei Goumilevski.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>