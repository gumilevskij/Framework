<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>snowdrop.src.numeric.solver.util &#8212; Python Platform 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for snowdrop.src.numeric.solver.util</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utility module functions.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">la</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.function</span> <span class="kn">import</span> <span class="n">get_function</span>
<span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.function</span> <span class="kn">import</span> <span class="n">get_function_and_jacobian</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial.hermite</span> <span class="kn">import</span> <span class="n">hermgauss</span> <span class="k">as</span>  <span class="n">hermgauss_numpy</span>

<span class="n">TOL</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">;</span> <span class="n">itr</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">shockLeadsLags</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">paramLeadsLags</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="is_pd">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.is_pd">[docs]</a>
<span class="k">def</span> <span class="nf">is_pd</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns true when input is positive-definite, via Cholesky&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="nearest_pd">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.nearest_pd">[docs]</a>
<span class="k">def</span> <span class="nf">nearest_pd</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the nearest positive-definite matrix to input A.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">eigh</span> 

    <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">eigh</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="n">A2</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">+</span> <span class="n">H</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="p">(</span><span class="n">A2</span> <span class="o">+</span> <span class="n">A2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">is_pd</span><span class="p">(</span><span class="n">A3</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">A3</span>

    <span class="n">spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">spacing</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">is_pd</span><span class="p">(</span><span class="n">A3</span><span class="p">):</span>
        <span class="n">mineig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">A3</span><span class="p">)))</span>
        <span class="n">A3</span> <span class="o">+=</span> <span class="n">I</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">mineig</span> <span class="o">*</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">spacing</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">A3</span></div>


<div class="viewcode-block" id="orthogonalize_shocks">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.orthogonalize_shocks">[docs]</a>
<span class="k">def</span> <span class="nf">orthogonalize_shocks</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses Cholesky decomposition to orthogonalize shocks.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object</span>
<span class="sd">        :type model: `Model&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shocks_names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;shocks&quot;</span><span class="p">]</span>
    <span class="n">n_shk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shocks_names</span><span class="p">)</span>
    <span class="n">shocks_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;shock_values&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
        <span class="n">shocks_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;shock_values&#39;</span><span class="p">]</span> 

    <span class="c1"># Matrix of coefficients of shocks</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span>
    
    <span class="c1"># Get shocks covariance matrix</span>
    <span class="n">cal</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">symbolic</span><span class="o">.</span><span class="n">calibration_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;std_&quot;</span><span class="p">)}</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_shk</span><span class="p">,</span><span class="n">n_shk</span><span class="p">))</span>  <span class="c1"># covariance matrices of shocks</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shocks_names</span><span class="p">):</span>
            <span class="n">std_v</span> <span class="o">=</span> <span class="s2">&quot;std_&quot;</span><span class="o">+</span><span class="n">v</span>
            <span class="k">if</span> <span class="n">std_v</span> <span class="ow">in</span> <span class="n">cal</span><span class="p">:</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal</span><span class="p">[</span><span class="n">std_v</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Q</span> <span class="o">@</span> <span class="n">R</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">R</span>
        
    <span class="c1"># Cholesky decomposition</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># try:</span>
    <span class="c1">#     L = la.cholesky(Q,lower=True)</span>
    <span class="c1"># except np.linalg.LinAlgError:</span>
    <span class="c1">#     L = la.cholesky(nearest_pd(Q),lower=True)</span>
        
    <span class="n">orthogonal_shocks</span> <span class="o">=</span> <span class="n">shocks_values</span> <span class="o">@</span> <span class="n">L</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;shock_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orthogonal_shocks</span>
    <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orthogonal_shocks</span></div>

    
<div class="viewcode-block" id="getCovarianceMatrix">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getCovarianceMatrix">[docs]</a>
<span class="k">def</span> <span class="nf">getCovarianceMatrix</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">calib</span><span class="p">,</span><span class="n">shocks</span><span class="p">,</span><span class="n">meas_shocks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build covariance matrices of errors of endogenous and measurement variables.</span>
<span class="sd">    </span>
<span class="sd">    It is assumed that standard deviations of variables are prefixed with &#39;std_RES_*&#39; or &#39;std_SHK_*&#39; name.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param Q: Covariance matrix of shocks errors.</span>
<span class="sd">        :type Q: numpy array.</span>
<span class="sd">        :param calib: Map of estimated shock names and values of standard deviations.</span>
<span class="sd">        :type calib: dict.</span>
<span class="sd">        :param shocks: List of shock variables.</span>
<span class="sd">        :type shocks: list.</span>
<span class="sd">        :param meas_shocks: List of shock of measurement variables.</span>
<span class="sd">        :type meas_shocks: list.</span>
<span class="sd">        :returns: Diagonal covariance matrices of endogenous variables.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shocks</span><span class="p">):</span>
        <span class="n">std_v</span> <span class="o">=</span> <span class="s2">&quot;std_&quot;</span><span class="o">+</span><span class="n">v</span>
        <span class="k">if</span> <span class="n">std_v</span> <span class="ow">in</span> <span class="n">calib</span><span class="p">:</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib</span><span class="p">[</span><span class="n">std_v</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">meas_shocks</span><span class="p">):</span>
        <span class="n">std_v</span> <span class="o">=</span> <span class="s2">&quot;std_&quot;</span><span class="o">+</span><span class="n">v</span>
        <span class="k">if</span> <span class="n">std_v</span> <span class="ow">in</span> <span class="n">calib</span><span class="p">:</span>
            <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">calib</span><span class="p">[</span><span class="n">std_v</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            
    <span class="k">return</span> <span class="n">Q</span><span class="p">,</span><span class="n">H</span></div>

            
<div class="viewcode-block" id="getCovarianceMatricies">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getCovarianceMatricies">[docs]</a>
<span class="k">def</span> <span class="nf">getCovarianceMatricies</span><span class="p">(</span><span class="n">measurement_variables</span><span class="p">,</span><span class="n">measurement_shocks</span><span class="p">,</span><span class="n">measurement_equations</span><span class="p">,</span><span class="n">shocks</span><span class="p">,</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build covariance matrices of errors of endogenous and measurement variables.</span>
<span class="sd">    </span>
<span class="sd">    It is assumed that standard deviations of variables are prefixed with &#39;std_RES_*&#39; or &#39;std_SHK_*&#39; name.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param measurement_variables: List of measurement variables.</span>
<span class="sd">        :type measurement_variables: list.</span>
<span class="sd">        :param measurement_shocks: Measurement shock variables.</span>
<span class="sd">        :type measurement_shocks: list.</span>
<span class="sd">        :param shocks: List of shock variables.</span>
<span class="sd">        :type shocks: list.</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :returns: Covariance matrices of endogenous `Q&#39; and measurement `H&#39; variables.</span>
<span class="sd">                  These covariance matrices are diagonal.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cal</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">symbolic</span><span class="o">.</span><span class="n">calibration_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;std_&quot;</span><span class="p">)}</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">,</span><span class="o">**</span><span class="n">cal</span><span class="p">}</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shocks</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>  <span class="c1"># covariance matrices of endogenous variables shocks</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shocks</span><span class="p">):</span>
        <span class="n">std_v</span> <span class="o">=</span> <span class="s2">&quot;std_&quot;</span><span class="o">+</span><span class="n">v</span>
        <span class="k">if</span> <span class="n">std_v</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">:</span>
            <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="n">std_v</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
       
    <span class="k">if</span> <span class="ow">not</span> <span class="n">measurement_shocks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">re</span>
        <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span>
        <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
    
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">measurement_variables</span><span class="p">)</span>        
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="c1"># covariance matrices of measurement variables shocks</span>
       
        <span class="k">for</span> <span class="n">shk</span> <span class="ow">in</span> <span class="n">measurement_shocks</span><span class="p">:</span>
            <span class="n">std_v</span> <span class="o">=</span> <span class="s2">&quot;std_&quot;</span><span class="o">+</span><span class="n">shk</span>
            <span class="k">if</span> <span class="n">std_v</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">eq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measurement_equations</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">shk</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eq</span><span class="p">)</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">measurement_variables</span><span class="p">:</span>
                                <span class="n">ind</span> <span class="o">=</span> <span class="n">measurement_variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                <span class="n">H</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="n">std_v</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">measurement_variables</span><span class="p">)</span>        
        <span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">options_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measurement_variables</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;std_&quot;</span><span class="p">,</span><span class="s2">&quot;std_res_&quot;</span><span class="p">,</span><span class="s2">&quot;std_shk_&quot;</span><span class="p">]:</span>
                <span class="n">std_v</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">std_v</span> <span class="ow">in</span> <span class="n">options_vars</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">options_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">std_v</span><span class="p">)</span>
                    <span class="n">std_v</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="n">std_v</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            
    <span class="k">return</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">H</span><span class="p">)</span></div>


<div class="viewcode-block" id="getAllShocks">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getAllShocks">[docs]</a>
<span class="k">def</span> <span class="nf">getAllShocks</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">periods</span><span class="p">,</span><span class="n">n_shocks</span><span class="p">,</span><span class="n">Npaths</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return list of shocks for all paths.</span>

<span class="sd">    Args:</span>
<span class="sd">        model : Model.</span>
<span class="sd">            Model object.</span>
<span class="sd">        periods : </span>
<span class="sd">            Simulation periods.</span>
<span class="sd">        n_shocks : int</span>
<span class="sd">            Number of shocks.</span>
<span class="sd">        Npaths : int</span>
<span class="sd">            Number of paths.</span>
<span class="sd">        T : int</span>
<span class="sd">            Time range.</span>

<span class="sd">    Returns:</span>
<span class="sd">        all_shocks : List</span>
<span class="sd">            List of shocks for all paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_lead_shock</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">max_lead_shock</span>
    <span class="n">min_lag_shock</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">min_lag_shock</span>
    <span class="n">bStochastic</span> <span class="o">=</span> <span class="s1">&#39;distribution&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span>
    <span class="k">if</span> <span class="s1">&#39;shock_values&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shock_values&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shock_values</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shock_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
               <span class="n">shock_values</span> <span class="o">=</span> <span class="n">shock_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="k">elif</span> <span class="s2">&quot;shocks&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;shocks&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shocks</span><span class="p">)</span>
    <span class="n">shock_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span>
        
    <span class="n">bPermanent</span><span class="o">=</span> <span class="ow">not</span> <span class="s2">&quot;periods&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span>
    <span class="n">all_shocks</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Npaths</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bStochastic</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span>
            <span class="n">shocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">n_shocks</span><span class="p">,</span><span class="n">T</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">shock</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">getShocks</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span><span class="n">shock_values</span><span class="o">=</span><span class="n">shock_values</span><span class="p">,</span><span class="n">n_shk</span><span class="o">=</span><span class="n">n_shocks</span><span class="p">,</span><span class="n">bStochastic</span><span class="o">=</span><span class="n">bStochastic</span><span class="p">,</span><span class="n">permanent_shocks</span><span class="o">=</span><span class="n">bPermanent</span><span class="p">)</span>
                <span class="n">shocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">shock</span><span class="p">))</span>
            <span class="n">shocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shocks</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_lead_shock</span> <span class="o">&gt;</span> <span class="n">min_lag_shock</span><span class="p">:</span>
                <span class="n">shocks</span> <span class="o">=</span> <span class="n">getCombinedShocks</span><span class="p">(</span><span class="n">shocks</span><span class="p">,</span><span class="n">n_shocks</span><span class="p">,</span><span class="n">T</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">min_lag_shock</span><span class="p">,</span><span class="n">max_lead_shock</span><span class="p">)</span>
  
        <span class="n">all_shocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">shocks</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">all_shocks</span></div>

        
<div class="viewcode-block" id="getShocks">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getShocks">[docs]</a>
<span class="k">def</span> <span class="nf">getShocks</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">shock_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">n_shk</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">bStochastic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">permanent_shocks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return shock values.</span>
<span class="sd">    It combines lead, lag and current values of shocks.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        :param i: Current period.</span>
<span class="sd">        :type i: int.</span>
<span class="sd">        :param t: Time.</span>
<span class="sd">        :type t: int.</span>
<span class="sd">        :param periods: list of periods at which shocks are applied.</span>
<span class="sd">        :type periods: List.</span>
<span class="sd">        :param shock_values: Array of shock values.</span>
<span class="sd">        :type shock_values: List.</span>
<span class="sd">        :param n_shk: Number of shocks</span>
<span class="sd">        :type n_shk: int.</span>
<span class="sd">        :param bStochastic: True means that shocks are stochastic and are described by an exogenous process. </span>
<span class="sd">        :type bStochastic: bool.</span>
<span class="sd">        :returns: Shocks values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shock_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">]</span>
        
    <span class="n">nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span>
                
    <span class="k">if</span> <span class="n">periods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">shock</span> <span class="o">=</span> <span class="n">shock_values</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shk</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shock</span> <span class="o">=</span> <span class="n">shock_values</span>
        <span class="k">return</span> <span class="n">shock</span><span class="p">,</span><span class="n">i</span>
            
           
    <span class="k">if</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dim1</span><span class="p">,</span><span class="n">dim2</span> <span class="o">=</span> <span class="n">shock_values</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">dim2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">shock_values</span><span class="p">):</span>
            <span class="n">shock_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">shock_values</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">nd</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">shock_values</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">n_shk</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shk</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">shock_values</span>
            <span class="n">shock_values</span> <span class="o">=</span> <span class="n">temp</span>
        
    <span class="k">if</span> <span class="n">bStochastic</span><span class="p">:</span>
        <span class="n">shock</span> <span class="o">=</span> <span class="p">[</span><span class="n">shock_values</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">permanent_shocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nd</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            
            <span class="n">shock</span> <span class="o">=</span> <span class="n">shock_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shock</span> <span class="o">=</span> <span class="n">shock_values</span>
    <span class="k">elif</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  
        <span class="n">shock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">periods</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">==</span><span class="n">periods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>   
            <span class="n">shock</span> <span class="o">=</span> <span class="n">shock_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shk</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  
        <span class="n">shock</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">n_shk</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">periods</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="o">==</span><span class="n">periods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">shock</span> <span class="o">=</span> <span class="p">[</span><span class="n">shock_values</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">if</span> <span class="n">n_shk</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">shock_values</span>                   
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="c1">#print(i,t,nd,PERMANENT_SHOCK,len(shock_values),shock)</span>
    <span class="k">return</span> <span class="n">shock</span><span class="p">,</span><span class="n">i</span></div>


<div class="viewcode-block" id="getCombinedShocks">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getCombinedShocks">[docs]</a>
<span class="k">def</span> <span class="nf">getCombinedShocks</span><span class="p">(</span><span class="n">shocks</span><span class="p">,</span><span class="n">n_shocks</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">min_lag_shock</span><span class="p">,</span><span class="n">max_lead_shock</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine lagged and lead shocks.</span>
<span class="sd">        </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param shocks: Array of shocks.</span>
<span class="sd">        :type shocks: np.array.</span>
<span class="sd">        :param n_shocks: Number of shock variables.</span>
<span class="sd">        :type n_shocks: int.</span>
<span class="sd">        :param T: Maximum time.</span>
<span class="sd">        :type t: int.</span>
<span class="sd">        :param min_lag_shock: Minimum lag of shocks</span>
<span class="sd">        :type min_lag_shock: int</span>
<span class="sd">        :param max_lead_shock: Maximum lead of shocks</span>
<span class="sd">        :type max_lead_shock: int</span>
<span class="sd">        </span>
<span class="sd">        :returns: Arrays of shocks arranged from laged shocks to lead shocks.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">shocks</span><span class="p">)</span>   
    <span class="n">shks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
          
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">shk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">max_lead_shock</span><span class="o">-</span><span class="n">min_lag_shock</span><span class="p">,</span><span class="n">n_shocks</span><span class="p">))</span> 
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_shocks</span><span class="p">):</span>
            <span class="n">leads_lags</span> <span class="o">=</span> <span class="n">shockLeadsLags</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">leads_lags</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">min_lag_shock</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">+</span><span class="n">ll</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t</span><span class="o">+</span><span class="n">ll</span> <span class="o">&lt;</span> <span class="n">T</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">shk</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">shocks</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="n">ll</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shk</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">shocks</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="n">ll</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
        
        <span class="n">shk</span> <span class="o">=</span> <span class="n">shk</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">max_lead_shock</span><span class="o">-</span><span class="n">min_lag_shock</span><span class="p">)</span><span class="o">*</span><span class="n">n_shocks</span><span class="p">)</span>
        <span class="n">shks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shk</span><span class="p">)</span>                 
                    
    <span class="n">combined_shocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shks</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">combined_shocks</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">combined_shocks</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">combined_shocks</span></div>


<div class="viewcode-block" id="getExogenousData">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getExogenousData">[docs]</a>
<span class="k">def</span> <span class="nf">getExogenousData</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return combined lag and lead time series.</span>

<span class="sd">    Args:</span>
<span class="sd">        model : Model.</span>
<span class="sd">            Model object.</span>
<span class="sd">        t : Time period.</span>
<span class="sd">            int.</span>
<span class="sd">       </span>
<span class="sd">    Returns:</span>
<span class="sd">        exog : List</span>
<span class="sd">            Exogenous data at time t.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.utils.util</span> <span class="kn">import</span> <span class="n">getExogenousSeries</span>
    
    <span class="n">max_lead_exog</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">max_lead_exog</span>
    <span class="n">min_lag_exog</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">min_lag_exog</span>
    <span class="n">exogenous</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exogenous&quot;</span><span class="p">,[])</span>
    <span class="n">exog_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exogenous&quot;</span><span class="p">,{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">exog_data</span><span class="p">):</span>
        <span class="n">exog_data</span> <span class="o">=</span> <span class="n">getExogenousSeries</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="n">exog</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exogenous</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_lag_exog</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">max_lead_exog</span><span class="p">):</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">exo</span> <span class="ow">in</span> <span class="n">exogenous</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exo</span> <span class="ow">in</span> <span class="n">exog_data</span><span class="p">:</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">exog_data</span><span class="p">[</span><span class="n">exo</span><span class="p">]</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ser</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">tt</span><span class="p">))</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">ser</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">exog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">exog</span></div>

        
<div class="viewcode-block" id="getStationaryVariables">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getStationaryVariables">[docs]</a>
<span class="k">def</span> <span class="nf">getStationaryVariables</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return stationary and non-stationary endogenous variables.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :param T: Transition matrix.</span>
<span class="sd">        :type T: 2-D ndarray.</span>
<span class="sd">        :param K: Vector of constants.</span>
<span class="sd">        :type K: 1-D ndarray.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="kn">from</span> <span class="nn">snowdrop.src.utils.equations</span> <span class="kn">import</span> <span class="n">getTopology</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="n">getTopology</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> 
    
    <span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">T</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">K</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># State transition matrix</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">][:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span>
        <span class="c1"># Array of constants</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
        
    <span class="n">eig</span><span class="p">,</span><span class="n">w</span>  <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

   <span class="c1"># Get non-stationary indices</span>
    <span class="n">unstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">len</span><span class="p">(</span><span class="n">eig</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">+</span><span class="mf">1.e-7</span><span class="p">]</span>
    <span class="n">non_stationary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="p">[:,</span><span class="n">unstable</span><span class="p">]),</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-7</span><span class="p">)</span>
    
    <span class="n">stationary</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_stationary</span><span class="p">]</span>
    <span class="n">var_non_stationary</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">non_stationary</span><span class="p">]</span>
    <span class="n">var_stationary</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stationary</span><span class="p">]</span>
    <span class="n">n_stationary</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stationary</span><span class="p">)</span>
    <span class="n">n_non_stationary</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_stationary</span><span class="p">)</span>
    
    <span class="n">stationaryRows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">var_stationary</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[:</span><span class="n">ind</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind</span><span class="p">:]</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[:</span><span class="n">ind</span><span class="p">])</span>
                    <span class="n">stationaryRows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    
    <span class="n">stationaryColumns</span> <span class="o">=</span> <span class="n">stationary</span>
    <span class="n">stationaryRows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stationaryRows</span><span class="p">)</span>
    <span class="n">nonStationaryColumns</span> <span class="o">=</span> <span class="n">non_stationary</span>
    <span class="n">nonStationaryRows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stationaryRows</span><span class="p">]</span>  
        
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stationary variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_stationary</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stationary variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">var_stationary</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of non-stationary variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_non_stationary</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-stationary variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">var_non_stationary</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">var_stationary</span><span class="p">,</span><span class="n">var_non_stationary</span><span class="p">,</span><span class="n">stationaryColumns</span><span class="p">,</span><span class="n">stationaryRows</span><span class="p">,</span><span class="n">nonStationaryColumns</span><span class="p">,</span><span class="n">nonStationaryRows</span></div>

    
<div class="viewcode-block" id="getStableUnstableVariables">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getStableUnstableVariables">[docs]</a>
<span class="k">def</span> <span class="nf">getStableUnstableVariables</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get indices of stable and unstable endogenous variables.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        model : Model</span>
<span class="sd">            Instance of model object.</span>
<span class="sd">        T: 2-D ndarray.</span>
<span class="sd">            State transition matrix.</span>
<span class="sd">        K: 1-D ndarray</span>
<span class="sd">            Vector of constants.</span>
<span class="sd">        debug : bool, optional</span>
<span class="sd">            If True prints names of stable and unstable variables..</span>

<span class="sd">    Returns:</span>
<span class="sd">        Indices of stable and unstable endogenous variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">T</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">K</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;A&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">snowdrop.src.numeric.solver.linear_solver</span> <span class="kn">import</span> <span class="n">solve</span>
            <span class="n">isLinear</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">isLinear</span>
            <span class="n">model</span><span class="o">.</span><span class="n">isLinear</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">isLinear</span> <span class="o">=</span> <span class="n">isLinear</span>
        <span class="c1"># State transition matrix</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">][:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span>
        <span class="c1"># Array of constants</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
        
    <span class="n">eig</span><span class="p">,</span><span class="n">w</span>  <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="c1">#TODO order the un-ordered eigen decomposition.</span>
    <span class="c1">#Q = la.pinv(T-np.eye(n)) @ K @ la.inv(w)</span>
    
    <span class="n">eig_stable</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eig</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1.e-8</span><span class="p">]</span>
    <span class="n">eig_unstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eig_stable</span><span class="p">]</span>
    <span class="n">rowUnstable</span> <span class="o">=</span> <span class="n">colUnstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">eig_unstable</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">]</span>
    <span class="n">rowStable</span> <span class="o">=</span> <span class="n">colStable</span>  <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colUnstable</span><span class="p">]</span>
    <span class="n">n_stable</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colStable</span><span class="p">)</span>
    <span class="n">n_unstable</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colUnstable</span><span class="p">)</span>
    <span class="n">var_stable</span>   <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colStable</span><span class="p">]</span>
    <span class="n">var_unstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colUnstable</span><span class="p">]</span>
      
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stable variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_stable</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stable variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">var_stable</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of unstable variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_unstable</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unstable variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">var_unstable</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">var_stable</span><span class="p">,</span><span class="n">var_unstable</span><span class="p">,</span><span class="n">colStable</span><span class="p">,</span><span class="n">rowStable</span><span class="p">,</span><span class="n">colUnstable</span><span class="p">,</span><span class="n">rowUnstable</span></div>

 
<div class="viewcode-block" id="getForwardLookingVariables">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getForwardLookingVariables">[docs]</a>
<span class="k">def</span> <span class="nf">getForwardLookingVariables</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get indices of forward/backward looking endogenous variables.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        model : Model</span>
<span class="sd">            Instance of model object.</span>
<span class="sd">        T: 2-D ndarray.</span>
<span class="sd">            State transition matrix.</span>
<span class="sd">        K: 1-D ndarray</span>
<span class="sd">            Vector of constants.</span>
<span class="sd">        debug : bool, optional</span>
<span class="sd">            If True prints names of backward and forward variables.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of backward and forward variables and their column and row numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.utils.equations</span> <span class="kn">import</span> <span class="n">getTopology</span>
    
    <span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
      
    <span class="n">rowForward</span> <span class="o">=</span> <span class="nb">list</span><span class="p">();</span> <span class="n">colForward</span> <span class="o">=</span> <span class="nb">list</span><span class="p">();</span> <span class="n">Map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="n">getTopology</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">lead_lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[:</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind</span><span class="p">:]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[:</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind</span><span class="p">:])</span> <span class="o">%</span> <span class="n">n</span>
            <span class="k">if</span> <span class="n">lead_lag</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">Map</span><span class="p">:</span>
                   <span class="n">Map</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
               <span class="n">rowForward</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
               <span class="n">colForward</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
               <span class="n">rows</span> <span class="o">=</span> <span class="n">Map</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
               <span class="k">if</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                   <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span> <span class="o">==</span> <span class="n">row</span><span class="p">:</span>
                           <span class="k">del</span> <span class="n">rowForward</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                       <span class="n">rows</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span>
                    
    <span class="n">colForward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">colForward</span><span class="p">)</span>
    <span class="n">rowForward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rowForward</span><span class="p">)</span>
    
    <span class="n">colBackward</span>  <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colForward</span><span class="p">]</span>  
    <span class="n">rowBackward</span>  <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rowForward</span><span class="p">]</span> 
    <span class="n">n_backward</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colBackward</span><span class="p">)</span>
    <span class="n">n_forward</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">n_backward</span>
    <span class="n">var_backward</span>  <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colBackward</span><span class="p">]</span>
    <span class="n">var_forward</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colForward</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of forward looking variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_forward</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forward looking variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">var_forward</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of static and backward looking variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_backward</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Static and backward looking  variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">var_backward</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">var_backward</span><span class="p">,</span><span class="n">var_forward</span><span class="p">,</span><span class="n">colBackward</span><span class="p">,</span><span class="n">rowBackward</span><span class="p">,</span><span class="n">colForward</span><span class="p">,</span><span class="n">rowForward</span></div>


<div class="viewcode-block" id="getStableUnstableRowsColumns">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getStableUnstableRowsColumns">[docs]</a>
<span class="k">def</span> <span class="nf">getStableUnstableRowsColumns</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return row and column numbers of stable and unstable endogenous variables.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">       :param model: Model object.</span>
<span class="sd">       :type model: Model.</span>
<span class="sd">       :param T: State transition matrix.</span>
<span class="sd">       :type T: 2-D ndarray.</span>
<span class="sd">       :param K: Vector of constants.</span>
<span class="sd">       :type K: 1-D ndarray.</span>
<span class="sd">       :returns: Array of starting values</span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="c1">#from snowdrop.src.utils.equations import getStableUnstableVariables</span>
    
    <span class="k">global</span> <span class="n">count</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">debug</span> <span class="o">&amp;=</span> <span class="n">count</span><span class="o">==</span><span class="mi">1</span>
    
    <span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        
    <span class="c1"># Get stable variables</span>
    <span class="n">var_stable</span><span class="p">,</span><span class="n">var_unstable</span><span class="p">,</span><span class="n">colStable</span><span class="p">,</span><span class="n">rowStable</span><span class="p">,</span><span class="n">colUnstable</span><span class="p">,</span><span class="n">rowUnstable</span> <span class="o">=</span> \
        <span class="n">getStableUnstableVariables</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
    <span class="n">model</span><span class="o">.</span><span class="n">stable</span> <span class="o">=</span> <span class="n">var_stable</span>
    <span class="n">model</span><span class="o">.</span><span class="n">unstable</span> <span class="o">=</span> <span class="n">var_unstable</span>
    
    <span class="n">n_cols_stable</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colStable</span><span class="p">)</span>
    <span class="n">n_rows_stable</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowStable</span><span class="p">)</span>
    <span class="n">n_stable</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_cols_stable</span><span class="p">,</span><span class="n">n_rows_stable</span><span class="p">)</span>
    <span class="c1">#n_unstable = n - n_stable</span>
    
    <span class="k">if</span> <span class="n">n_rows_stable</span> <span class="o">&gt;</span> <span class="n">n_stable</span><span class="p">:</span>
        <span class="n">rowStable</span> <span class="o">=</span> <span class="n">rowStable</span><span class="p">[:</span><span class="n">n_stable</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">n_cols_stable</span> <span class="o">&gt;</span> <span class="n">n_stable</span><span class="p">:</span>
        <span class="n">colStable</span> <span class="o">=</span> <span class="n">colStable</span><span class="p">[:</span><span class="n">n_stable</span><span class="p">]</span>
        
    <span class="n">colUnstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">colStable</span><span class="p">]</span>
    <span class="n">rowUnstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rowStable</span><span class="p">]</span>
    <span class="n">n_cols_stable</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colStable</span><span class="p">)</span>
    
    <span class="n">varstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">var_stable</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;_minus_&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;_plus_&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">varunstable</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">var_unstable</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;_minus_&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;_plus_&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stable variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varstable</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stable variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">varstable</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of unstable variables: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varunstable</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unstable variables: &quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">varunstable</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">rowStable</span><span class="p">,</span><span class="n">colStable</span><span class="p">,</span><span class="n">rowUnstable</span><span class="p">,</span><span class="n">colUnstable</span> </div>


<div class="viewcode-block" id="find_starting_lag_values">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.find_starting_lag_values">[docs]</a>
<span class="k">def</span> <span class="nf">find_starting_lag_values</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find starting values of lead/lag variables.</span>
<span class="sd">     </span>
<span class="sd">    These are starting values of variables with lead or lag greater than one.</span>
<span class="sd">     </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :returns: Array of starting values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TOLERANCE</span> <span class="o">=</span> <span class="mf">1.e-8</span>
    <span class="n">NITERATIONS</span> <span class="o">=</span> <span class="mi">100</span>
    
    <span class="c1"># Define objective function</span>
    <span class="k">def</span> <span class="nf">fobj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">get_function_and_jacobian</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>
	
    <span class="n">n_shk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">])</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">getParameters</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">getShocks</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span><span class="n">n_shk</span><span class="o">=</span><span class="n">n_shk</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span>   
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;_minus_&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;__m_&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
                                
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">TOLERANCE</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span><span class="n">NITERATIONS</span><span class="p">})</span>
        <span class="n">historic_values</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">historic_values</span> <span class="o">=</span> <span class="n">v</span>
       
    <span class="k">return</span> <span class="n">historic_values</span><span class="p">,</span><span class="n">indices</span></div>

    
<div class="viewcode-block" id="find_eigen_values">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.find_eigen_values">[docs]</a>
<span class="k">def</span> <span class="nf">find_eigen_values</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">steady_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find eigen values of Jacobian.</span>
<span class="sd">     </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :param steady_state: Endogenous variables steady states.</span>
<span class="sd">        :type steady_state: list.</span>
<span class="sd">        :returns: Eigen values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">eigen_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">getParameters</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">steady_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">steady_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">steady_state</span><span class="p">,</span><span class="n">steady_state</span><span class="p">,</span><span class="n">steady_state</span><span class="p">))</span>
    <span class="n">func</span><span class="p">,</span><span class="n">jacob</span> <span class="o">=</span>  <span class="n">get_function_and_jacobian</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">jacob</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">jacob</span><span class="p">[:,</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">jacob</span><span class="p">[:,</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
    
    <span class="c1"># Build A,B matrices: A*[dt(t+1), dy(t)] = B*[dt(t), dy(t-1)] </span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>
    <span class="n">A</span><span class="p">[:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span>
    <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>
    <span class="n">B</span><span class="p">[:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">C</span>
    <span class="n">B</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">L</span>
    <span class="n">B</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
    <span class="c1"># Get QZ matrix decomposition (or generalized Schur decomposition)</span>
    <span class="n">AA</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">qz</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">)</span>
    <span class="c1">#Compute eigen values as ratio of diagonal elements of BD and AD</span>
    <span class="n">BD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">BB</span><span class="p">)</span>
    <span class="n">AD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">AA</span><span class="p">)</span>
    
    <span class="c1">## Compute eigen values as ratio of beta and alpha</span>
    <span class="n">eigen_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">BD</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">AD</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">AD</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1.e-10</span>
    <span class="n">model</span><span class="o">.</span><span class="n">nUnit</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigen_values</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">nStable</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigen_values</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="o">-</span><span class="n">tol</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">nUnstable</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigen_values</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="o">+</span><span class="n">tol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eigen_values</span></div>

	
<div class="viewcode-block" id="checkSteadyState">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.checkSteadyState">[docs]</a>
<span class="k">def</span> <span class="nf">checkSteadyState</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">endog</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find values of equations residuals for a given steady state.</span>
<span class="sd">     </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :param endog: List of endogenous variables values.</span>
<span class="sd">        :type endog: list.</span>
<span class="sd">        :returns: Array of equations residuals.</span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="n">n_shk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">getParameters</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">getShocks</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span><span class="n">n_shk</span><span class="o">=</span><span class="n">n_shk</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">endog</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">steady_state</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">steady_state</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;checkSteadyState: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is not present in model steady-state map!&quot;</span><span class="p">)</span>
            
    <span class="n">errors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;f_static&quot;</span><span class="p">](</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">errors</span></div>

	
<div class="viewcode-block" id="checkSolution">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.checkSolution">[docs]</a>
<span class="k">def</span> <span class="nf">checkSolution</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">periods</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return errors of equations given solution.</span>
<span class="sd">     </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :param periods: Array of periods.</span>
<span class="sd">        :type periods: numpy.array.</span>
<span class="sd">        :param y: Array of endogenous variables values.</span>
<span class="sd">        :type y: np.array.</span>
<span class="sd">        :returns: Array of equations residuals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shock_var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">]</span>
    <span class="n">n_shocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;shock_values&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shock_values&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shocks</span><span class="p">)</span>
    <span class="n">shock_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span> 
        
    <span class="n">params</span> <span class="o">=</span> <span class="n">getParameters</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    
    <span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">n_shk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">])</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">shocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">shock</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">getShocks</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span><span class="n">shock_values</span><span class="o">=</span><span class="n">shock_values</span><span class="p">,</span><span class="n">n_shk</span><span class="o">=</span><span class="n">n_shk</span><span class="p">)</span>
        <span class="n">shocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shock</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">res</span> <span class="o">=</span>  <span class="n">get_function_and_jacobian</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">shock</span><span class="o">=</span><span class="n">shock</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
           
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span></div>

      
<div class="viewcode-block" id="find_residuals">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.find_residuals">[docs]</a>
<span class="k">def</span> <span class="nf">find_residuals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find values of shocks that minimize errors of equations.</span>
<span class="sd">     </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :param y: Array of endogenous varuables values.</span>
<span class="sd">        :type y: np.array.</span>
<span class="sd">        :returns: Array of endogenous variables residuals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    

    <span class="c1"># Define objective function</span>
    <span class="k">def</span> <span class="nf">fobj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">ytm</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="n">ytp</span><span class="p">]</span>
        <span class="n">func</span> <span class="o">=</span>  <span class="n">get_function_and_jacobian</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">shock</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
	
    <span class="n">shock_names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">]</span>
    <span class="n">n_shk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_names</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">getParameters</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">eqs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbolic</span><span class="o">.</span><span class="n">equations</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eqs</span><span class="p">)</span>
    
    <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span>
    <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">();</span> <span class="n">lShocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># Skip measurement equations</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">eqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eq</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">shock_names</span><span class="p">:</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">shock_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">lShocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">lShocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lShocks</span><span class="p">)</span>
    <span class="n">n_ind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        
    <span class="n">T</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">tm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ytm</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="n">ytp</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">tm</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">tp</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shk</span><span class="p">)</span>
        <span class="n">f</span><span class="p">,</span><span class="n">jacob</span> <span class="o">=</span> <span class="n">get_function_and_jacobian</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">ytm</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="n">ytp</span><span class="p">])</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">jacob</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">:]</span>
        <span class="c1"># Skip measurement shocks</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_shk</span> <span class="o">==</span> <span class="n">n_ind</span><span class="p">:</span>
                <span class="c1"># Finding residuals using the direct method</span>
                <span class="n">e</span><span class="p">[</span><span class="n">lShocks</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">la</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="c1"># Finding residuals using minimization method</span>
                <span class="n">e</span><span class="p">[</span><span class="n">lShocks</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">@</span> <span class="n">rhs</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">e</span><span class="p">[</span><span class="n">lShocks</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lShocks</span><span class="p">))</span>
            
        <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
           
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span></div>


<div class="viewcode-block" id="decompose">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.decompose">[docs]</a>
<span class="k">def</span> <span class="nf">decompose</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">endog</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">periods</span><span class="p">,</span><span class="n">isKF</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decomposes the right-hand-side of equations into components that are caused by contributions of endogenous variables one at a time.</span>
<span class="sd">     </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: Model.</span>
<span class="sd">        :param y: Values of endogenous variables.</span>
<span class="sd">        :type y: numpy.array</span>
<span class="sd">        :param endog: Valiables names.</span>
<span class="sd">        :type endog: List.</span>
<span class="sd">        :param n: Endogenous variable name.</span>
<span class="sd">        :type n: str.</span>
<span class="sd">        :param T: Time span.</span>
<span class="sd">        :type T: int.</span>
<span class="sd">        :param periods: Vector of periods that define shocks timing.</span>
<span class="sd">        :type periods: numpy.array.</span>
<span class="sd">        :param isKF: True if shocks are obtained by Kalman Filter.</span>
<span class="sd">        :type isKF: bool.</span>
<span class="sd">        :returns: Array of decompositions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">split</span><span class="p">,</span><span class="n">escape</span>
    <span class="kn">import</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">sys</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">warnoptions</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">var</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">var_labels</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;variables_labels&quot;</span><span class="p">,{})</span>
     
    <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span> 
    <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
        
    <span class="n">shock_names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">]</span>
    <span class="n">n_shocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_names</span><span class="p">)</span>
    <span class="n">exog_names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exogenous&#39;</span><span class="p">,[])</span>
    <span class="n">ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exog_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;adjusted_shocks&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adjusted_shocks&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;shocks&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">getAllShocks</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span><span class="n">n_shocks</span><span class="o">=</span><span class="n">n_shocks</span><span class="p">,</span><span class="n">Npaths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shock_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n_shocks</span>
    <span class="n">shock_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span>
   
    
    <span class="c1"># Remove periods if it is not set in model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;periods&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="n">nd_shock</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">max_lead_shock</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">min_lag_shock</span> 
        
    <span class="n">eqs</span>  <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbolic</span><span class="o">.</span><span class="n">equations</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;f_rhs&quot;</span><span class="p">]</span>
    <span class="n">ne</span> <span class="o">=</span> <span class="mi">0</span>
       
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">eq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eqs</span><span class="p">):</span>
        <span class="c1"># Exclude exogenous variablesx</span>
        
        <span class="n">arr</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">eq1</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eq2</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="n">ind1</span><span class="p">:]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ind1</span>
            <span class="n">eq1</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind2</span><span class="p">]</span>
            <span class="n">eq2</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[:</span><span class="n">ind1</span><span class="p">]</span>
            
        <span class="n">eq1</span> <span class="o">=</span> <span class="n">eq1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">eq2</span> <span class="o">=</span> <span class="n">eq2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">leftEqArr</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eq1</span><span class="p">)</span>
        <span class="n">leftEqArr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">leftEqArr</span><span class="p">))</span>
        <span class="n">rightEqArr</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eq2</span><span class="p">)</span>
        <span class="n">rightEqArr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">rightEqArr</span><span class="p">))</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rightEqArr</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">endog</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())]</span>
        <span class="n">variables2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rightEqArr</span><span class="p">:</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">eq2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">eq2</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">eq2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
                    <span class="n">ind2</span> <span class="o">=</span> <span class="n">eq2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span>
                    <span class="n">variables2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq2</span><span class="p">[</span><span class="n">ind1</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">ind2</span><span class="p">])</span>
                    <span class="n">eq2</span> <span class="o">=</span> <span class="n">eq2</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">variables2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">eq2</span> <span class="o">=</span> <span class="n">eq2</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eq2</span> <span class="o">=</span> <span class="n">eq2</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind</span><span class="p">:]</span>
                
        <span class="n">var</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">variables2</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">leftEqArr</span><span class="p">:</span>
            <span class="n">ne</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ne</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Ensure that we treat only one equation at a time</span>
                <span class="k">continue</span>
            
            <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;exogenous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1">### Endogenous variables</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">v2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span><span class="n">variables2</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="n">x</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                        <span class="n">z</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-10</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                    <span class="n">ym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
                    <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                    <span class="n">yp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t do decomposition for starting conditions.</span>
                        <span class="n">yc</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span> <span class="n">ym</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span> <span class="n">yp</span> <span class="o">*=</span> <span class="mf">1.e-10</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;(-&quot;</span> <span class="ow">in</span> <span class="n">v2</span><span class="p">:</span>
                            <span class="c1"># For lag variables set current amd lead variables to zero.</span>
                            <span class="n">yc</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span> <span class="n">yp</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span>
                        <span class="k">elif</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">v2</span> <span class="ow">or</span> <span class="s2">&quot;(+&quot;</span> <span class="ow">in</span> <span class="n">v2</span><span class="p">:</span>
                            <span class="c1"># For lead variables set current amd lag variables to zero.</span>
                            <span class="n">yc</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span> <span class="n">ym</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># For current variables set lead amd lag variables to zero.</span>
                            <span class="n">ym</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span> <span class="n">yp</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span>
                    <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ym</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="n">yp</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">shock</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd_shock</span><span class="o">*</span><span class="n">n_shocks</span><span class="p">),</span><span class="n">exog</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ne</span><span class="p">))</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                    <span class="n">vv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">var_label</span> <span class="o">=</span> <span class="n">var_labels</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="k">if</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">var_labels</span> <span class="k">else</span> <span class="n">v2</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">var_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>
            
            <span class="c1">### Shocks</span>
            <span class="n">shock_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shock_names</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rightEqArr</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">shock_variables</span><span class="p">):</span>
                    
                <span class="n">shock_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_labels</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">var_labels</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shock_variables</span><span class="p">]</span>
    
                <span class="n">z</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.e-10</span>
                <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">z</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span>
                <span class="n">shocks</span> <span class="o">=</span> <span class="p">[]</span>
        
                <span class="k">if</span> <span class="n">isKF</span><span class="p">:</span>
                    <span class="n">shocks</span> <span class="o">=</span> <span class="n">shock_values</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_values</span><span class="p">):</span>
                                <span class="n">shock</span> <span class="o">=</span> <span class="n">shock_values</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> 
                                <span class="n">shocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shock</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">shock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">periods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                                <span class="n">shock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">shock_values</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="ow">not</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
                                <span class="n">shock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shocks</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
                                <span class="n">shocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">shock</span><span class="p">))</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">shock</span><span class="o">=</span><span class="n">shocks</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">exog</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ne</span><span class="p">))</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                    <span class="n">vv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shock_variables</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vv</span>
              
            
            <span class="c1">### Exogenous variables</span>
            <span class="n">shock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd_shock</span><span class="o">*</span><span class="n">n_shocks</span><span class="p">)</span>
            <span class="n">exog_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exog_names</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rightEqArr</span><span class="p">]</span>
            <span class="n">exog_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_labels</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">var_labels</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exog_variables</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">exog_variables</span><span class="p">):</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.e-10</span>
                <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">z</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">exog</span> <span class="o">=</span> <span class="n">getExogenousData</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">get_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span><span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">shock</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nd_shock</span><span class="o">*</span><span class="n">n_shocks</span><span class="p">))</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
                    <span class="n">vv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exog_labels</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vv</span>
        
    <span class="n">var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span><span class="n">var</span> </div>


<div class="viewcode-block" id="getParameters">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getParameters">[docs]</a>
<span class="k">def</span> <span class="nf">getParameters</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return model parameters.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param parameters: Values of parameters.</span>
<span class="sd">        :type parameters: numpy.array.</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: model.</span>
<span class="sd">        :param t: Current period.</span>
<span class="sd">        :type t: int.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dim1</span><span class="p">,</span><span class="n">dim2</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">dim2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">parameters</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">paramLeadsLags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dim1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">paramLeadsLags</span><span class="p">))):</span>
                <span class="n">j1</span><span class="p">,</span><span class="n">j2</span> <span class="o">=</span> <span class="n">paramLeadsLags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">j2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="n">j2</span><span class="p">),</span><span class="n">dim2</span><span class="p">)</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">params</span></div>


<div class="viewcode-block" id="qzdiv">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.qzdiv">[docs]</a>
<span class="k">def</span> <span class="nf">qzdiv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cluster</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reorder QZ decomposition matrices.</span>
<span class="sd">    </span>
<span class="sd">    Takes U.T. matrices A, B, orthogonal matrices Q,Z, rearranges them</span>
<span class="sd">    according to the order of matrix roots: abs(B(i,i)/A(i,i)) </span>
<span class="sd">    so that lower values are in lower right corner, while </span>
<span class="sd">    preserving U.T. and orthonormal properties and Q&#39;AZ&#39; and Q&#39;BZ&#39;.  </span>
<span class="sd">    The columns of v are sorted correspondingly.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
        <span class="n">n</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
        <span class="n">m</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">b</span>  <span class="o">=</span> <span class="n">root</span><span class="o">&lt;=</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">root</span><span class="o">&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">root</span><span class="o">&lt;=</span><span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">b</span>  <span class="o">=</span> <span class="n">b1</span><span class="o">*</span><span class="n">b2</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">root</span><span class="o">&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">cl</span>
        
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
        
    <span class="n">diagA</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
    <span class="n">diagB</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>
    <span class="n">diagA</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">diagA</span><span class="p">,</span><span class="n">diagB</span><span class="p">)]</span>
    <span class="n">root</span>  <span class="o">=</span> <span class="n">diagB</span> <span class="o">/</span> <span class="n">diagA</span>
    
    
    <span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Reorder matrices by the diagonal values ascending order</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
           <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">root</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="n">root</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                  <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">qzswitch2</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
                  <span class="n">root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">B</span><span class="p">))])</span>
                  <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                  
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Reorder matrices by cluster order</span>
        
        <span class="n">cl</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
           <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">cl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cl</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                  <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">qzswitch2</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
                  <span class="n">root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">B</span><span class="p">))])</span>
                  <span class="n">cl</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                  <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">v</span></div>


<div class="viewcode-block" id="qzdiv2">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.qzdiv2">[docs]</a>
<span class="k">def</span> <span class="nf">qzdiv2</span><span class="p">(</span><span class="n">stake</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reorder QZ decomposition matrices.</span>
<span class="sd">    </span>
<span class="sd">    Takes U.T. matrices A, B, orthonormal matrices Q,Z, rearranges them</span>
<span class="sd">    so that all cases of abs(B(i,i)/A(i,i))&gt;stake are in lower right </span>
<span class="sd">    corner, while preserving U.T. and orthonormal properties and Q&#39;AZ&#39; and</span>
<span class="sd">    Q&#39;BZ&#39;.  The columns of v are sorted correspondingly.</span>
<span class="sd">    </span>
<span class="sd">    by Christopher A. Sims</span>
<span class="sd">    modified (to add v to input and output) 7/27/2000</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
    <span class="n">diagA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">diagB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">root</span>  <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">diagA</span><span class="p">,</span><span class="n">diagB</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ind</span>   <span class="o">=</span> <span class="n">root</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.e-13</span>
    <span class="n">temp</span>  <span class="o">=</span> <span class="n">root</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">root</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">root</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ind</span> <span class="o">*</span> <span class="n">temp</span>
    <span class="n">root</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">root</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
          <span class="c1">#print(i,j,func(root[j,1]),root[j,1])</span>
          <span class="k">if</span> <span class="n">root</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stake</span> <span class="ow">or</span> <span class="n">root</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
              <span class="n">m</span> <span class="o">=</span> <span class="n">j</span>
              <span class="k">break</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
          <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">v</span>
       
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
          <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">qzswitch2</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
          <span class="n">root</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">root</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">root</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
          <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">v</span>      </div>


<div class="viewcode-block" id="qzswitch">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.qzswitch">[docs]</a>
<span class="k">def</span> <span class="nf">qzswitch</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Swap QZ decomposition matrices.  This is a simplified version of Sims&#39; code.</span>
<span class="sd">    </span>
<span class="sd">    Takes U.T. matrices A, B, orthonormal matrices Q,Z, interchanges</span>
<span class="sd">    diagonal elements i and i+1 of both A and B, while maintaining</span>
<span class="sd">    Q&#39;AZ&#39; and Q&#39;BZ&#39; unchanged.  If diagonal elements of A and B</span>
<span class="sd">    are zero at matching positions, the returned A will have zeros at both</span>
<span class="sd">    positions on the diagonal.  This is natural behavior if this routine is used</span>
<span class="sd">    to drive all zeros on the diagonal of A to the lower right, but in this case</span>
<span class="sd">    the qz transformation is not unique and it is not possible simply to switch</span>
<span class="sd">    the positions of the diagonal elements of both A and B.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">];</span>   <span class="n">d</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">];</span>     <span class="n">b</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="n">f</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">*</span><span class="n">e</span><span class="o">-</span><span class="n">f</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">f</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">b</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">f</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wz</span> <span class="o">@</span> <span class="n">wz</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xy</span> <span class="o">@</span> <span class="n">xy</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">n</span><span class="o">*</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span>
    
    <span class="n">wz</span> <span class="o">=</span> <span class="n">wz</span><span class="o">/</span><span class="n">n</span><span class="p">;</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span><span class="o">/</span><span class="n">m</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">wz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="n">wz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])</span>
    <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wz</span><span class="p">,</span><span class="n">temp</span><span class="p">])</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xy</span><span class="p">,</span><span class="n">temp</span><span class="p">])</span>
       
    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">@</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
    <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">@</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
    <span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">wz</span>
    <span class="n">B</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">wz</span>
    <span class="n">Z</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">wz</span>
    <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">@</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
    
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span></div>


<div class="viewcode-block" id="qzswitch2">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.qzswitch2">[docs]</a>
<span class="k">def</span> <span class="nf">qzswitch2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Swap QZ decomposition matrices.  </span>
<span class="sd">    This is an original version of Sims&#39; code.</span>
<span class="sd">    </span>
<span class="sd">    Takes U.T. matrices A, B, orthonormal matrices Q,Z, interchanges</span>
<span class="sd">    diagonal elements i and i+1 of both A and B, while maintaining</span>
<span class="sd">    Q&#39;AZ&#39; and Q&#39;BZ&#39; unchanged.  If diagonal elements of A and B</span>
<span class="sd">    are zero at matching positions, the returned A will have zeros at both</span>
<span class="sd">    positions on the diagonal.  This is natural behavior if this routine is used</span>
<span class="sd">    to drive all zeros on the diagonal of A to the lower right, but in this case</span>
<span class="sd">    the qz transformation is not unique and it is not possible simply to switch</span>
<span class="sd">    the positions of the diagonal elements of both A and B.</span>
<span class="sd">    </span>
<span class="sd">    Translated from the original Sims&#39; Matlab code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1.e-15</span>
    <span class="n">realsmall</span> <span class="o">=</span> <span class="mf">1.e-7</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">];</span>   <span class="n">d</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">];</span>     <span class="n">b</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="n">f</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;</span><span class="n">realsmall</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">&lt;</span><span class="n">realsmall</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&lt;</span><span class="n">realsmall</span><span class="p">:</span>
            <span class="c1"># l.r. coincident 0&#39;s with u.l. of A=0; do nothing</span>
            <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span>
        <span class="k">else</span><span class="p">:</span>
    		<span class="c1"># l.r. coincident zeros; put 0 in u.l. of a</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b</span><span class="p">,</span><span class="o">-</span><span class="n">a</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="n">wz</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wz</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span> <span class="o">@</span> <span class="n">wz</span><span class="p">)</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="o">-</span><span class="n">wz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])))</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&lt;</span><span class="n">realsmall</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">&lt;</span><span class="n">realsmall</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;</span><span class="n">realsmall</span><span class="p">:</span>
            <span class="c1"># u.l. coincident zeros with l.r. of A=0; do nothing</span>
            <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># u.l. coincident zeros; put 0 in l.r. of A</span>
            <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">])</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xy</span> <span class="o">@</span> <span class="n">xy</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="o">-</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()]),</span> <span class="n">xy</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># usual case</span>
        <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">*</span><span class="n">e</span><span class="o">-</span><span class="n">f</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">f</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">b</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">d</span><span class="o">-</span><span class="n">f</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wz</span> <span class="o">@</span> <span class="n">wz</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xy</span> <span class="o">@</span> <span class="n">xy</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">eps</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
            <span class="c1"># all elements of A and B proportional</span>
            <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span>

        <span class="n">wz</span> <span class="o">=</span> <span class="n">wz</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">/</span> <span class="n">m</span>
        <span class="n">wz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">wz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="n">wz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])))</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(),</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()])))</span>

    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">@</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
    <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">@</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
    <span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">wz</span>
    <span class="n">B</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">wz</span>
    <span class="n">Z</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">@</span> <span class="n">wz</span>
    <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">@</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
    
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span></div>


<div class="viewcode-block" id="cartesian">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.cartesian">[docs]</a>
<span class="k">def</span> <span class="nf">cartesian</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a cartesian product of input arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        arrays: list of array-like</span>
<span class="sd">            1-D arrays to form the cartesian product of.</span>
<span class="sd">        out: ndarray</span>
<span class="sd">            Array to place the cartesian product in.</span>

<span class="sd">    Returns:</span>
<span class="sd">        out : ndarray</span>
<span class="sd">            2-D array of shape (M, len(arrays)) containing cartesian products</span>
<span class="sd">            formed of input arrays.</span>

<span class="sd">    Examples:</span>
<span class="sd">        </span>
<span class="sd">    &gt;&gt;&gt; cartesian(([1, 2, 3], [4, 5], [6, 7]))</span>
<span class="sd">    &gt;&gt;&gt; array([[1, 4, 6],</span>
<span class="sd">               [1, 4, 7],</span>
<span class="sd">               [1, 5, 6],</span>
<span class="sd">               [1, 5, 7],</span>
<span class="sd">               [2, 4, 6],</span>
<span class="sd">               [2, 4, 7],</span>
<span class="sd">               [2, 5, 6],</span>
<span class="sd">               [2, 5, 7],</span>
<span class="sd">               [3, 4, 6],</span>
<span class="sd">               [3, 4, 7],</span>
<span class="sd">               [3, 5, 6],</span>
<span class="sd">               [3, 5, 7]])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">]</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">cartesian</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">m</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">out</span></div>

	
<div class="viewcode-block" id="hermgauss">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.hermgauss">[docs]</a>
<span class="k">def</span> <span class="nf">hermgauss</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute weights and nodes of Gauss-Hermite quadrature.</span>

<span class="sd">    Credits : both routines below are ported from the Compecon Toolbox</span>
<span class="sd">    by Paul L Fackler and Mario J. Miranda.</span>
<span class="sd">    Original code is available at http://www4.ncsu.edu/~pfackler/compecon/toolbox.html</span>
<span class="sd">   </span>
<span class="sd">    Translated from Matlab code to Python by A.G.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxit</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">pim4</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mf">0.25</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="c1"># reasonable starting values</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mf">1.85575</span><span class="o">*</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">-</span><span class="mf">1.14</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">**</span><span class="mf">0.426</span><span class="p">)</span><span class="o">/</span><span class="n">z</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mf">1.86</span><span class="o">*</span><span class="n">z</span><span class="o">+</span><span class="mf">0.86</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mf">1.91</span><span class="o">*</span><span class="n">z</span><span class="o">+</span><span class="mf">0.91</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># root finding iterations</span>
        <span class="n">its</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">its</span> <span class="o">&lt;</span> <span class="n">maxit</span><span class="p">:</span>
            <span class="n">its</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">pim4</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">p3</span> <span class="o">=</span> <span class="n">p2</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">p1</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">p2</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">p3</span><span class="p">;</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">p2</span>
            <span class="n">z1</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z1</span><span class="o">-</span><span class="n">p1</span><span class="o">/</span><span class="n">pp</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-14</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">its</span> <span class="o">&gt;=</span> <span class="n">maxit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failure to converge&#39;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">z</span>
        <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="n">pp</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">w</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">]</span></div>


<div class="viewcode-block" id="gauss_hermite_nodes">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.gauss_hermite_nodes">[docs]</a>
<span class="k">def</span> <span class="nf">gauss_hermite_nodes</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the weights and nodes for Gauss Hermite quadrature.</span>

<span class="sd">    Args:</span>
<span class="sd">        orders : int, list, array</span>
<span class="sd">            The order of integration used in the quadrature routine</span>
<span class="sd">        sigma : array-like</span>
<span class="sd">            If one dimensional, the variance of the normal distribution being</span>
<span class="sd">            approximated. If multidimensional, the variance-covariance matrix of</span>
<span class="sd">            the multivariate normal process being approximated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        x : array</span>
<span class="sd">            Quadrature nodes</span>
<span class="sd">        w : array</span>
<span class="sd">            Quadrature weights</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="p">[</span><span class="n">orders</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">herms</span> <span class="o">=</span> <span class="p">[</span><span class="n">hermgauss</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">]</span>

    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">herms</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">herms</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Note: if sigma is 2D, x will always be 2D, even if sigma is only 1x1.</span>
        <span class="c1"># print(points.shape)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sigma</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cartesian</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

        <span class="n">zero_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sigma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">zero_columns</span><span class="p">:</span>
            <span class="n">sigma</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">mu</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">zero_columns</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span><span class="mi">0</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_hermite">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.test_hermite">[docs]</a>
<span class="k">def</span> <span class="nf">test_hermite</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test hermgauss.&quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">xg</span><span class="p">,</span><span class="n">wg</span><span class="p">]</span> <span class="o">=</span> <span class="n">hermgauss_numpy</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">hermgauss</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="n">wg</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xg</span><span class="p">)</span></div>

	

<div class="viewcode-block" id="getTrend">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getTrend">[docs]</a>
<span class="k">def</span> <span class="nf">getTrend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get trend component.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param data: Observation data.</span>
<span class="sd">        :type data: pandas DataFrame.</span>
<span class="sd">        :param deg: Fitted polynomial degree.</span>
<span class="sd">        :type deg: int.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">T</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">trend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
            <span class="n">yi</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">slope</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">slope</span><span class="o">*</span><span class="n">X</span>
            <span class="k">elif</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">curv</span><span class="p">,</span><span class="n">slope</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">slope</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="n">curv</span><span class="o">*</span><span class="n">X</span><span class="o">*</span><span class="n">X</span>
            <span class="n">data</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fit</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="n">i</span><span class="p">])]</span>
            <span class="n">trend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        
    <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">trend</span><span class="p">,</span><span class="n">data</span></div>

    
<div class="viewcode-block" id="getTrendCofficients">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getTrendCofficients">[docs]</a>
<span class="k">def</span> <span class="nf">getTrendCofficients</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an array with steady state paths for all variables.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: The Model object.</span>
<span class="sd">        :type model: instance of class Model.</span>
<span class="sd">        :param T: Time range.</span>
<span class="sd">        :type T: int.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trend_coeff</span><span class="p">,</span><span class="n">unstable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    
    <span class="k">if</span> <span class="s2">&quot;A&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span> <span class="ow">and</span> <span class="s2">&quot;C&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
        
        <span class="n">w</span><span class="p">,</span><span class="n">U</span>  <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">unst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">+</span><span class="mf">1.e-7</span>
        <span class="n">unstable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="n">unst</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-7</span><span class="p">)</span>   
        
        <span class="n">v</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">])</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">x</span>  <span class="o">=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span>  <span class="n">A</span> <span class="o">@</span> <span class="n">x</span> <span class="o">+</span> <span class="n">C</span>
            
        <span class="n">trend_coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">T</span>
        <span class="n">trend_coeff</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">trend_coeff</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1.e-10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">return</span> <span class="n">trend_coeff</span><span class="p">[</span><span class="n">unstable</span><span class="p">],</span><span class="n">unstable</span></div>


<div class="viewcode-block" id="sorter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.sorter">[docs]</a>
<span class="k">def</span> <span class="nf">sorter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort eigen values.</span>
<span class="sd">    </span>
<span class="sd">    The sorting algorithm of ordered Schur decomposition function.</span>

<span class="sd">    Args:</span>
<span class="sd">        a : Diagonal element of Schur decomposition.</span>
<span class="sd">            complex or real array.</span>
<span class="sd">        b : Diagonal element of Schur decomposition.</span>
<span class="sd">            complex or real array.</span>

<span class="sd">    Returns:</span>
<span class="sd">        clusters : np.array</span>
<span class="sd">            Clusters of eigen values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TOLERANCE</span> <span class="o">=</span> <span class="mf">1e-10</span>
    <span class="n">eigval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span>
    <span class="n">stable</span> <span class="o">=</span> <span class="n">eigval</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">TOLERANCE</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eigval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TOLERANCE</span>
    <span class="n">unstable</span> <span class="o">=</span> <span class="n">eigval</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">TOLERANCE</span>
    
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">clusters</span><span class="p">[</span><span class="n">stable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">clusters</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">clusters</span><span class="p">[</span><span class="n">unstable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">return</span> <span class="n">clusters</span></div>


<div class="viewcode-block" id="clustered_sorter">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.clustered_sorter">[docs]</a>
<span class="k">def</span> <span class="nf">clustered_sorter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">div</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort eigen values.</span>
<span class="sd">    </span>
<span class="sd">    The sorting algorithm of General Schur decomposition function.</span>

<span class="sd">    Args:</span>
<span class="sd">        a : Diagonal element of Schur decomposition.</span>
<span class="sd">            complex or real array.</span>
<span class="sd">        b : Diagonal element of Schur decomposition.</span>
<span class="sd">            complex or real array.</span>

<span class="sd">    Returns:</span>
<span class="sd">        clusters : np.array</span>
<span class="sd">            Clusters of eigen values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eigval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span>
    <span class="n">stable</span> <span class="o">=</span> <span class="n">eigval</span> <span class="o">&lt;=</span> <span class="n">div</span>
    <span class="n">unstable</span> <span class="o">=</span> <span class="n">eigval</span> <span class="o">&gt;</span> <span class="n">div</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eigval</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">clusters</span><span class="p">[</span><span class="n">unstable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">clusters</span><span class="p">[</span><span class="n">stable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">return</span> <span class="n">clusters</span></div>


<div class="viewcode-block" id="arnoldi_iteration">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.arnoldi_iteration">[docs]</a>
<span class="k">def</span> <span class="nf">arnoldi_iteration</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes a basis of the (n + 1)-Krylov subspace of A: the space spanned by {b, Ab, ..., A^n b}.</span>

<span class="sd">    Arguments:</span>
<span class="sd">      A: m × m array</span>
<span class="sd">      </span>
<span class="sd">      b: initial vector (length m)</span>
<span class="sd">      </span>
<span class="sd">      n: dimension of Krylov subspace, must be &gt;= 1</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">      Q: m x (n + 1) array, the columns are an orthonormal basis of the Krylov subspace.</span>
<span class="sd">      </span>
<span class="sd">      h: (n + 1) x n array, A on basis Q. It is upper Hessenberg.  </span>
<span class="sd">      </span>
<span class="sd">    Please see: </span>
<span class="sd">        </span>
<span class="sd">    * https://en.wikipedia.org/wiki/Arnoldi_iteration </span>
<span class="sd">    </span>
<span class="sd">    * https://en.wikipedia.org/wiki/Generalized_minimal_residual_method</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># Normalize the input vector</span>
    <span class="n">Q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>  <span class="c1"># Use it as the first Krylov vector</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>  <span class="c1"># Generate a new candidate vector</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Subtract the projections on previous vectors</span>
            <span class="n">h</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">h</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">Q</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>

        <span class="n">h</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-12</span>  <span class="c1"># If v is shorter than this threshold it is the zero vector</span>
        <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span>  <span class="c1"># Add the produced vector to the list, unless</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>  <span class="c1"># the zero vector is produced.</span>
            <span class="n">Q</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If that happens, stop iterating.</span>
            <span class="k">return</span> <span class="n">Q</span><span class="p">,</span> <span class="n">h</span>
    <span class="k">return</span> <span class="n">Q</span><span class="p">,</span> <span class="n">h</span></div>


<div class="viewcode-block" id="getIndicesAndData">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getIndicesAndData">[docs]</a>
<span class="k">def</span> <span class="nf">getIndicesAndData</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">row_ind</span><span class="p">,</span><span class="n">col_ind</span><span class="p">,</span><span class="n">jacob</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build row and column indices and partition jacobian matrix into lead, current, and lag parts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of rows.</span>
<span class="sd">    row_ind : list</span>
<span class="sd">        Row indices.</span>
<span class="sd">    col_ind : list</span>
<span class="sd">        Column indices.</span>
<span class="sd">    jacob : 2d numpy.array</span>
<span class="sd">        Jacobian matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lead_row_ind : list</span>
<span class="sd">        Row indices of lead variables.</span>
<span class="sd">    lead_col_ind : list</span>
<span class="sd">        Column indices of lead variables.</span>
<span class="sd">    lead_data : list</span>
<span class="sd">        Jacobian matrix of lead variables.</span>
<span class="sd">    current_row_ind : list</span>
<span class="sd">        Row indices of current variables</span>
<span class="sd">    current_col_ind : list</span>
<span class="sd">        Column indices of current variables.</span>
<span class="sd">    current_data : list</span>
<span class="sd">        Jacobian matrix of current variables.</span>
<span class="sd">    lag_row_ind : list</span>
<span class="sd">        Row indices of lag variables</span>
<span class="sd">    lag_col_ind : list</span>
<span class="sd">        Column indices of lag variables.</span>
<span class="sd">    lag_data : list</span>
<span class="sd">        Jacobian matrix of lag variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lead_row_ind</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lead_col_ind</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lead_data</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">current_row_ind</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">current_col_ind</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">current_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lag_row_ind</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lag_col_ind</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lag_data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jacob</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row_ind</span><span class="p">,</span><span class="n">col_ind</span><span class="p">,</span><span class="n">jacob</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">lead_row_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">lead_col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">lead_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span>
                <span class="n">current_row_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">current_col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
                <span class="n">current_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">:</span>
                <span class="n">lag_row_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">lag_col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
                <span class="n">lag_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row_ind</span><span class="p">,</span><span class="n">col_ind</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">lead_row_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">lead_col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">lead_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jacob</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span>
                <span class="n">current_row_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">current_col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
                <span class="n">current_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jacob</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">:</span>
                <span class="n">lag_row_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">lag_col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
                <span class="n">lag_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jacob</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">lead_row_ind</span><span class="p">,</span><span class="n">lead_col_ind</span><span class="p">,</span><span class="n">lead_data</span><span class="p">,</span><span class="n">current_row_ind</span><span class="p">,</span><span class="n">current_col_ind</span><span class="p">,</span><span class="n">current_data</span><span class="p">,</span><span class="n">lag_row_ind</span><span class="p">,</span><span class="n">lag_col_ind</span><span class="p">,</span><span class="n">lag_data</span> </div>

        
<div class="viewcode-block" id="getMatrix">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getMatrix">[docs]</a>
<span class="k">def</span> <span class="nf">getMatrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">row_ind</span><span class="p">,</span><span class="n">col_ind</span><span class="p">,</span><span class="n">jacob</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build matrix given row, column and data indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of rows.</span>
<span class="sd">    row_ind : list</span>
<span class="sd">        Row indices.</span>
<span class="sd">    col_ind : list</span>
<span class="sd">        Column indices.</span>
<span class="sd">    jacob : 2d numpy.array</span>
<span class="sd">        Jacobian matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lead_row_ind : list</span>
<span class="sd">        Row indices of lead variables.</span>
<span class="sd">    lead_col_ind : list</span>
<span class="sd">        Column indices of lead variables.</span>
<span class="sd">    lead_data : list</span>
<span class="sd">        Jacobian matrix of lead variables.</span>
<span class="sd">    current_row_ind : list</span>
<span class="sd">        Row indices of current variables</span>
<span class="sd">    current_col_ind : list</span>
<span class="sd">        Column indices of current variables.</span>
<span class="sd">    current_data : list</span>
<span class="sd">        Jacobian matrix of current variables.</span>
<span class="sd">    lag_row_ind : list</span>
<span class="sd">        Row indices of lag variables</span>
<span class="sd">    lag_col_ind : list</span>
<span class="sd">        Column indices of lag variables.</span>
<span class="sd">    lag_data : list</span>
<span class="sd">        Jacobian matrix of lag variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row_ind</span><span class="p">,</span><span class="n">col_ind</span><span class="p">,</span><span class="n">jacob</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        
    <span class="k">return</span> <span class="n">data</span> </div>


<div class="viewcode-block" id="checkBK">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.checkBK">[docs]</a>
<span class="k">def</span> <span class="nf">checkBK</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">qz_factor</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mf">1.e-6</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check Blachard-Kahn Condition.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.misc.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.utils.equations</span> <span class="kn">import</span> <span class="n">getTopology</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.preprocessor.function</span> <span class="kn">import</span> <span class="n">get_function_and_jacobian</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>  
    <span class="n">e</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">calibration</span><span class="p">[</span><span class="s1">&#39;shocks&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">max_lead_shock</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">min_lag_shock</span><span class="p">)</span>
    <span class="c1"># n_shock = len(model.symbols[&#39;shocks&#39;])</span>
    <span class="c1"># e = [0]*n_shock</span>
    <span class="n">forward_columns</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">C</span><span class="p">,</span><span class="n">jacob</span> <span class="o">=</span> <span class="n">get_function_and_jacobian</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">shock</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
    <span class="n">Jacob</span> <span class="o">=</span> <span class="n">jacob</span><span class="p">[:</span><span class="n">n</span><span class="p">,:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
    
    <span class="n">mp</span> <span class="o">=</span> <span class="n">getTopology</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> 
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">lead_lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[:</span><span class="n">ind</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">lead_lag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind</span><span class="p">:]</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">var_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ind</span><span class="p">:])</span>
                <span class="n">forward_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_col</span><span class="p">)</span>
    
    <span class="n">forward_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">variables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">forward_columns</span><span class="p">]</span>
    <span class="n">N_forward</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">forward_columns</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">N_forward</span>
    
    <span class="c1">### ------------------- Make structural state-space representation of equations</span>
    <span class="c1"># Build matrix A</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
    <span class="c1"># Current values</span>
    <span class="n">A</span><span class="p">[:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jacob</span><span class="p">[:,</span><span class="n">n</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
    <span class="c1"># Lead variables values</span>
    <span class="n">A</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">Jacob</span><span class="p">[:,</span><span class="n">forward_columns</span><span class="p">]</span>
    <span class="c1"># Identity equations</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_forward</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">forward_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
    <span class="c1"># Build matrix A</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
    <span class="c1"># Lag variables values</span>
    <span class="n">B</span><span class="p">[:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">Jacob</span><span class="p">[:,</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>
    <span class="c1"># Identity equations</span>
    <span class="n">B</span><span class="p">[</span><span class="n">n</span><span class="p">:,</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N_forward</span><span class="p">)</span>
    
    <span class="c1"># Matrix of constants</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">C</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_forward</span><span class="p">)))</span>
    
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matrix A:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matrix B:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vector C:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">C1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>   
    <span class="c1">### ------------------------ Generalized Schur decomposition (a.k.a. QZ decomposition) to the pencil (A,B)</span>
    
    
    <span class="c1"># If the QZ re-ordering fails, change the order of equations .</span>
    <span class="c1"># Place the first equation last, and repeat.</span>
    <span class="n">eqOrd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">shuffle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">AA</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">eqOrd</span><span class="p">]</span>
        <span class="n">BB</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">eqOrd</span><span class="p">]</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">ordqz</span><span class="p">(</span><span class="n">AA</span><span class="p">,</span><span class="n">BB</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;real&#39;</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="n">sorter</span><span class="p">)</span> 
        
        <span class="c1"># Transpose matrix</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Reorder decomposition matrices so that eigen values are ordered.</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">col_order</span> <span class="o">=</span> <span class="n">qzdiv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
            
        <span class="c1"># Find number of stable and unstable roots</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">b</span><span class="p">))])</span>
        <span class="c1">#print(roots)</span>
        <span class="n">n_unstable</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">roots</span><span class="o">&gt;=</span><span class="n">qz_factor</span><span class="p">)</span>
        <span class="n">n_stable</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="n">n_unstable</span>  
            
        <span class="c1"># Reshuffle equations order if QZ algorithm fails</span>
        <span class="n">unstable_roots</span> <span class="o">=</span> <span class="n">roots</span><span class="p">[</span><span class="n">n_stable</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unstable_roots</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">-</span><span class="n">qz_factor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">N_forward</span> <span class="o">!=</span> <span class="n">n_unstable</span><span class="p">:</span>
            <span class="n">eqOrd</span> <span class="o">=</span> <span class="n">eqOrd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">eqOrd</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># Check correctness of QZ decomposition</span>
    <span class="n">err1</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">a</span> <span class="o">@</span> <span class="n">z</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">AA</span><span class="p">)</span> <span class="o">/</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">AA</span><span class="p">)</span>
    <span class="n">err2</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">b</span> <span class="o">@</span> <span class="n">z</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">BB</span><span class="p">)</span> <span class="o">/</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">BB</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err1</span> <span class="o">&gt;</span> <span class="mf">1.e-10</span> <span class="ow">or</span> <span class="n">err2</span> <span class="o">&gt;</span> <span class="mf">1.e-10</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Klein Solver: QZ decomposition error.  </span><span class="se">\n</span><span class="s2"> Inconsistency of A and B matrices decomposition of </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">err1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="nb">round</span><span class="p">(</span><span class="n">err2</span><span class="p">,</span><span class="mi">4</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;n_unstable=&#39;</span><span class="p">,</span><span class="n">n_unstable</span><span class="p">,</span><span class="s1">&#39;,   n_forward_looking=&#39;</span><span class="p">,</span><span class="n">N_forward</span><span class="p">,</span><span class="s1">&#39;   forward variables=&#39;</span><span class="p">,</span><span class="n">forward_variables</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;roots:&#39;</span><span class="p">,</span><span class="n">roots</span><span class="p">)</span>
        
    <span class="c1"># Check Blanchard-Kahn condition</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">N_forward</span> <span class="o">==</span> <span class="n">n_unstable</span><span class="p">:</span> 
        <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Blanchard-Kahn condition of existence and unique solution is satisfied.&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span><span class="s1">&#39;underline&#39;</span><span class="p">])</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">N_forward</span> <span class="o">&lt;</span> <span class="n">n_unstable</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of unstable roots </span><span class="si">{</span><span class="n">n_unstable</span><span class="si">}</span><span class="s2"> is larger than number of forward looking variables </span><span class="si">{</span><span class="n">N_forward</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Blanchard-Kahn condition is not satisfied: no stable solution!&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;underline&#39;</span><span class="p">])</span> 
        <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of unstable roots </span><span class="si">{</span><span class="n">n_unstable</span><span class="si">}</span><span class="s2"> is smaller than number of forward looking variables </span><span class="si">{</span><span class="n">N_forward</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Blanchard-Kahn condition is not satisfied: multiple stable solutions!&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;underline&#39;</span><span class="p">])</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nb">print</span><span class="p">()</span>
         
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unstable_roots</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Some of unstable roots are less than one: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">unstable_roots</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">return</span> <span class="n">status</span></div>

    
<div class="viewcode-block" id="get_adjusted_shocks">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.get_adjusted_shocks">[docs]</a>
<span class="k">def</span> <span class="nf">get_adjusted_shocks</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">shocks</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get shocks that satisfy model equations.</span>
<span class="sd">        </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :type model: `Model&#39;.</span>
<span class="sd">        :param x: Solution.</span>
<span class="sd">        :type x: numpy 2D array.</span>
<span class="sd">        :param shocks: Shocks at different time periods..</span>
<span class="sd">        :type shocks: list.</span>
<span class="sd">        :param N: Number of time periods.</span>
<span class="sd">        :type N: int.</span>
<span class="sd">        </span>
<span class="sd">        :returns: List of shocks that satisfy original equations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.misc.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
    
    <span class="n">TOLERANCE</span> <span class="o">=</span> <span class="mf">1.e-8</span><span class="p">;</span> <span class="n">NITERATIONS</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">delimiters</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span>
    <span class="n">regexPattern</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
      
    <span class="n">adjusted_shocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">shocks</span><span class="p">)</span>
    <span class="n">shock_names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;shocks&quot;</span><span class="p">]</span>
    <span class="n">n_shocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shock_names</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">getParameters</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    
    <span class="n">f_dynamic</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;f_dynamic&quot;</span><span class="p">]</span>
    <span class="n">bHasAttr</span>  <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f_dynamic</span><span class="p">,</span><span class="s2">&quot;py_func&quot;</span><span class="p">)</span>
    
    <span class="c1"># Define objective function</span>
    <span class="k">def</span> <span class="nf">fobj</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">exog</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">itr</span>
        <span class="n">itr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">z</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bHasAttr</span><span class="p">:</span>
                <span class="n">func</span><span class="p">,</span><span class="n">jacob</span> <span class="o">=</span> <span class="n">f_dynamic</span><span class="o">.</span><span class="n">py_func</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">exog</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">,</span><span class="n">jacob</span> <span class="o">=</span> <span class="n">f_dynamic</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">exog</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mf">1.e10</span> <span class="o">+</span> <span class="n">itr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="n">lst_eqs</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">ind</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">eqs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbolic</span><span class="o">.</span><span class="n">equations</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">eq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eqs</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regexPattern</span><span class="p">,</span><span class="n">eq</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">arr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shock</span> <span class="ow">in</span> <span class="n">shock_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shock</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">lst_eqs</span><span class="p">:</span>
                    <span class="n">lst_eqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">:</span>
                    <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="n">getExogenousData</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_shocks</span><span class="p">),</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">exog</span><span class="p">),</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">TOLERANCE</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">NITERATIONS</span><span class="p">,</span> <span class="s2">&quot;disp&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>      
        <span class="n">adjusted_shocks</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span>
        <span class="n">b</span> <span class="o">&amp;=</span> <span class="n">sol</span><span class="o">.</span><span class="n">success</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;numeric.solver.util: Cannot find adjusted shocks&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        
    <span class="n">adjusted_shocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">adjusted_shocks</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst_eqs</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">adjusted_shocks</span><span class="p">)</span>   
        
    <span class="k">return</span> <span class="n">adjusted_shocks</span></div>

    
<div class="viewcode-block" id="getMatlabMatrices">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getMatlabMatrices">[docs]</a>
<span class="k">def</span> <span class="nf">getMatlabMatrices</span><span class="p">(</span><span class="n">n_meas_shocks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read Matlab matrices.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">mat4py</span> <span class="kn">import</span> <span class="n">loadmat</span>
    <span class="kn">import</span> <span class="nn">os</span>
    
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">working_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;../../../..&quot;</span><span class="p">)))</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s2">&quot;/data/toy/iris.mat&quot;</span><span class="p">)</span>
    <span class="n">Omg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Omg&quot;</span><span class="p">])</span>
    <span class="n">Pa0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Pa0&quot;</span><span class="p">])</span>
    <span class="n">Painit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Painit&quot;</span><span class="p">])</span>
    <span class="n">Ta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ta&quot;</span><span class="p">])</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">])</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">])</span>
    <span class="n">Ka</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ka&quot;</span><span class="p">])</span>
    <span class="n">Ka</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Ka</span><span class="p">)</span>
    <span class="n">Ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ra&quot;</span><span class="p">])</span>
    <span class="n">Ra</span> <span class="o">=</span> <span class="n">Ra</span><span class="p">[:,</span><span class="n">n_meas_shocks</span><span class="p">:]</span>
    
    <span class="k">return</span> <span class="n">U</span><span class="p">,</span><span class="n">Ta</span><span class="p">,</span><span class="n">Ra</span><span class="p">,</span><span class="n">Ka</span><span class="p">,</span><span class="n">Painit</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Pa0</span><span class="p">,</span><span class="n">Omg</span></div>


<div class="viewcode-block" id="getMatrices">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getMatrices">[docs]</a>
<span class="k">def</span> <span class="nf">getMatrices</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.numeric.solver.linear_solver</span> <span class="kn">import</span> <span class="n">solve</span>
    <span class="n">solve</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># State transition matrix</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">][:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span>
    <span class="c1"># Array of constants</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
    <span class="c1"># Matrix of shocks</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">linear_model</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span></div>


<div class="viewcode-block" id="getOneVarEqsSolution">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.getOneVarEqsSolution">[docs]</a>
<span class="k">def</span> <span class="nf">getOneVarEqsSolution</span><span class="p">(</span><span class="n">lvars</span><span class="p">,</span><span class="n">lfunc</span><span class="p">,</span><span class="n">largs</span><span class="p">,</span><span class="n">leqs</span><span class="p">,</span><span class="n">mv</span><span class="p">,</span><span class="n">mp</span><span class="p">,</span><span class="n">exog_data</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve one variable equations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        :param lvars: List of equations variables.</span>
<span class="sd">        :type lvars: list.</span>
<span class="sd">        :param lfunc: Compiled functions.</span>
<span class="sd">        :type lfunc: list.</span>
<span class="sd">        :param largs: Functions arguments.</span>
<span class="sd">        :type largs: list.</span>
<span class="sd">        :param leqs: Equations.</span>
<span class="sd">        :type leqs: list.</span>
<span class="sd">        :param mv: Values of variables.</span>
<span class="sd">        :type mv: dictionary.</span>
<span class="sd">        :param mp: Parameters.</span>
<span class="sd">        :type mp: dictionary.</span>
<span class="sd">        :param exog_data: Exogenous data.</span>
<span class="sd">        :type exog_data: dictionary.</span>
<span class="sd">        :param T: Time span.</span>
<span class="sd">        :type T: int.</span>
<span class="sd">        :returns: Dictionary of time series.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.misc.termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.utils.util</span> <span class="kn">import</span> <span class="n">findVariableLag</span>
    <span class="kn">from</span> <span class="nn">snowdrop.src.utils.util</span> <span class="kn">import</span> <span class="n">findVariableLead</span>

    <span class="n">m</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">eq</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lvars</span><span class="p">,</span><span class="n">lfunc</span><span class="p">,</span><span class="n">largs</span><span class="p">,</span><span class="n">leqs</span><span class="p">):</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="p">):</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">lag</span> <span class="o">=</span> <span class="n">findVariableLag</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">lead</span> <span class="o">=</span> <span class="n">findVariableLead</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;__&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)]</span> 
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">exog_data</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">exog_data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="n">tt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="n">lag</span><span class="o">+</span><span class="n">lead</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">mv</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">lst</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
                <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">bSuccess</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error computing equation: </span><span class="si">{</span><span class="n">eq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">; function arguments: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bSuccess</span><span class="p">:</span> 
            <span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
            
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mv</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mv</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
               
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">One Variable Equation Solver: elapsed time </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (sec.)&quot;</span><span class="p">,</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span></div>

    
<span class="c1"># Original code from  https://yuminlee2.medium.com/union-find-algorithm-ffa9cd7d2dba               </span>
<div class="viewcode-block" id="UnionFind">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.UnionFind">[docs]</a>
<span class="k">class</span> <span class="nc">UnionFind</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numOfElements</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numOfElements</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">numOfElements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">numOfElements</span>

    <span class="c1"># Time: O(logn) | Space: O(1)</span>
<div class="viewcode-block" id="UnionFind.find_set">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.UnionFind.find_set">[docs]</a>
    <span class="k">def</span> <span class="nf">find_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">node</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
            <span class="c1"># path compression</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">node</span><span class="p">]]</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">node</span></div>

    
    <span class="c1"># Time: O(1) | Space: O(1)</span>
<div class="viewcode-block" id="UnionFind.union_set">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.UnionFind.union_set">[docs]</a>
    <span class="k">def</span> <span class="nf">union_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">):</span>
        <span class="n">root1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="n">node1</span><span class="p">)</span>
        <span class="n">root2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="n">node2</span><span class="p">)</span>

        <span class="c1"># already in the same set</span>
        <span class="k">if</span> <span class="n">root1</span> <span class="o">==</span> <span class="n">root2</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">[</span><span class="n">root2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span> <span class="o">=</span> <span class="n">root1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">root1</span><span class="p">]</span> <span class="o">=</span> <span class="n">root2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">[</span><span class="n">root2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span></div>
</div>

        
<div class="viewcode-block" id="check">
<a class="viewcode-back" href="../../../../../source/snowdrop.src.numeric.solver.html#snowdrop.src.numeric.solver.util.check">[docs]</a>
<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
    <span class="n">uf</span> <span class="o">=</span> <span class="n">UnionFind</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">union_set</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">uf</span><span class="o">.</span><span class="n">find_set</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">uf</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">uf</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of connected components:&quot;</span><span class="p">,</span> <span class="n">uf</span><span class="o">.</span><span class="n">count</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main program.&quot;&quot;&quot;</span>
    <span class="n">test_hermite</span><span class="p">()</span>
    <span class="n">check</span><span class="p">()</span>
    
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">Python Platform</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/modules.html">snowdrop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../info.html">Python Platform</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Alexei Goumilevski.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>